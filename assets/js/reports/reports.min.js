jQuery(function(t){new DLM_Reports});class DLM_Reports{constructor(){this.chartContainer=document.getElementById("total_downloads_chart");const t=this.chartContainer.getContext("2d");this.chartColors={purple:{default:"rgba(149, 76, 233, 1)",half:"rgba(149, 76, 233, 0.75)",quarter:"rgba(149, 76, 233, 0.5)",zero:"rgba(149, 76, 233, 0.05)"},indigo:{default:"rgba(80, 102, 120, 1)",quarter:"rgba(80, 102, 120, 0.5)"}},this.chartGradient=t.createLinearGradient(0,25,0,300),this.chartGradient.addColorStop(0,this.chartColors.purple.half),this.chartGradient.addColorStop(.45,this.chartColors.purple.quarter),this.chartGradient.addColorStop(1,this.chartColors.purple.zero),this.datePickerContainer=document.getElementById("dlm-date-range-picker"),this.reportsData="undefined"!=typeof dlmReportsStats?JSON.parse(JSON.stringify(dlmReportsStats)):{},this.mostDownloaded=!1,this.stats=!1,this.chartType="day",this.createDataOnDate(!1,!1),this.datePicker={opened:!1},this.init()}getDates(t,e){const a=[];let o=t;for(;o<=e;)a[this.createDateElement(o)]=0,o=this.getNextDay(o);return a}getMonths(t){const e=[];return Object.keys(t).map(t=>{t=t.substring(0,7);void 0===e[t]&&(e[t]=0)}),e}getWeeks(t){const a=[];return Object.keys(t).map(t=>{let e;e=15<moment(t).date()?t.substring(0,7)+"-15":t.substring(0,7)+"-1",void 0===a[e]&&(a[e]=0)}),a}getNextDay(t){const e=new Date(t);return e.setDate(t.getDate()+1),e}createDateElement(t){var e=(t.getMonth()+1<10?"0":"")+(t.getMonth()+1);return t.getFullYear()+"-"+e+"-"+t.getDate()}createDataOnDate(t,e){const o=this;let a,n,r,s,d;if(o.reportsData="undefined"!=typeof dlmReportsStats?JSON.parse(JSON.stringify(dlmReportsStats)):{},void 0!==t&&t)a=o.createDateElement(new Date(t));else{const m=new Date;m.setDate(m.getDate()-30),a=o.createDateElement(m)}if(void 0!==e&&e)n=o.createDateElement(new Date(e));else{const p=new Date;p.setDate(p.getDate()+1),n=o.createDateElement(p)}r=moment(n,"YYYY-MM-DD").month()-moment(a,"YYYY-MM-DD").month(),console.log(r),moment(n,"YYYY-MM-DD").year()!==moment(a,"YYYY-MM-DD").year()||6<r?o.chartType="month":1<=r?(o.chartType="weeks",1==r&&moment(n,"YYYY-MM-DD").date()<=moment(a,"YYYY-MM-DD").date()&&(o.chartType="day")):o.chartType="day";let i=o.getDates(new Date(a),new Date(n)),l=o.getMonths(i),h=o.getWeeks(i);Object.values(o.reportsData).forEach((a,t)=>{var e=JSON.parse(a.download_ids);if(void 0!==i[a.date])switch(o.chartType){case"month":s=a.date.substring(0,7),Object.values(e).forEach((t,e)=>{l[s]=void 0!==l[s]?l[s]+t.downloads:t.downloads}),d=l;break;case"weeks":s=15<moment(a.date).date()?a.date.substring(0,7)+"-15":a.date.substring(0,7)+"-1",Object.values(e).forEach((t,e)=>{h[s]=void 0!==h[s]?h[s]+t.downloads:t.downloads}),d=h;break;case"day":Object.values(e).forEach((t,e)=>{i[a.date]=i[a.date]+t.downloads}),d=i}else delete o.reportsData[t]});t=Object.keys(i).length,e=Object.keys(i).findIndex(t=>a===t);let c=Object.keys(i).findIndex(t=>n===t);-1!==e||-1!==c?(-1===c&&(c=t),o.stats={chartStats:Object.assign({},d),summaryStats:o.reportsData,daysLength:t}):o.stats={chartStats:Object.assign({},d),summaryStats:!1,daysLength:t}}dlmCreateChart(e,t){if(e&&t){const o=this,n=Chart.getChart("total_downloads_chart");void 0!==n&&n.destroy();var a=[{label:"Downloads",color:"#27ae60",data:e,type:"line",fill:!0,backgroundColor:o.chartGradient,pointBackgroundColor:o.chartColors.purple.default,borderColor:o.chartColors.purple.default,lineTension:.2,borderWidth:2,pointRadius:3,elements:{line:{borderColor:"#2ecc71",borderWidth:2}}}];o.chart=new Chart(t,{title:"",data:{datasets:a},height:450,show_dots:0,x_axis_mode:"tick",y_axis_mode:"span",is_series:1,options:{aspectRatio:3,animation:!1,scales:{x:{grid:{display:!1},ticks:{callback:t=>void 0!==o.chartType&&"month"===o.chartType?moment(Object.keys(e)[t]).format("D MMM YY"):moment(Object.keys(e)[t]).format("D MMM")}}},normalized:!0,parsing:{xAxisKey:"x",yAxisKey:"y"},plugins:{tooltip:{backgroundColor:"#fff",titleColor:o.chartColors.purple.default,titleAlign:"center",titleFont:{weight:"bold",size:18},padding:{left:15,right:15,top:30,bottom:30},cornerRadius:8,borderColor:o.chartColors.purple.default,borderWidth:1,displayColors:!1,bodyColor:"#000",callbacks:{title:t=>t[0].formattedValue,label:t=>"",beforeLabel:t=>"Downloads",afterLabel:t=>"undefined"!==o.chartType&&"month"===o.chartType?moment(t.label).format("MMMM, YYYY"):moment(t.label).format("dddd, MMMM Do YYYY"),labelTextColor:t=>o.chartColors.purple.half}}}}})}}dlmDownloadsSummary(){let a={},o=0;if(!1===this.stats||!1===this.stats.summaryStats||Object.keys(this.stats.summaryStats).length<=0)return this.setTotalDownloads(0),this.setDailyAverage(0),this.setMostDownloaded("--"),void this.setTopDownloads(0,!0);this.stats.summaryStats.forEach(t=>{t=JSON.parse(t.download_ids),Object.entries(t).forEach(([t,e])=>{o+=e.downloads,a[t]=void 0===a[t]?{downloads:e.downloads,title:e.title,id:t}:{downloads:a[t].downloads+e.downloads,title:e.title,id:t}})}),this.mostDownloaded=Object.values(a).sort((t,e)=>t.downloads-e.downloads).reverse(),this.setTotalDownloads(o),this.setDailyAverage((o/parseInt(this.stats.daysLength)).toFixed(2)),this.setMostDownloaded(this.mostDownloaded[0].title),this.setTopDownloads()}createDatepicker(){const t=new Date;let e=t.getDate()-1,a=t.getMonth()+1,o=a-1;var n=t.getFullYear();e<10&&(e="0"+e),a<10&&(a="0"+a),o<10&&(o="0"+o);var r=n+"-"+a+"-"+e,s=n+"-"+o+"-"+e,d=jQuery("<div>").addClass("dlm_rdrs_overlay"),n=jQuery("<div>").attr("id","dlm_date_range_picker");return this.startDateInput=jQuery("<input>").attr("type","hidden").attr("id","dlm_start_date").attr("value",s),this.endDateInput=jQuery("<input>").attr("type","hidden").attr("id","dlm_end_date").attr("value",r),d.append(n).append(this.startDateInput).append(this.endDateInput),d}displayDatepicker(){if(!this.datePicker.opened){this.datePicker.opened=!0;let n=this.createDatepicker();const r=0<Object.keys(dlmReportsStats).length?new Date(dlmReportsStats[0].date):new Date,s=new Date;jQuery(this.datePickerContainer).append(n);const d=[];if(r.getTime()!==s.getTime()){let t=new Date,a=moment().month(s.getMonth()-1).startOf("month")._d,e=new Date(s.getFullYear(),s.getMonth(),1),o=moment().startOf("year")._d,n=moment().year(s.getFullYear()-1).month(0).startOf("month")._d;t=t.setDate(t.getDate()-6),r.getTime()<t&&d.push({name:"Last 7 Days",dates:function(){return[new Date(s.getFullYear(),s.getMonth(),s.getDate()-7),new Date(s.getFullYear(),s.getMonth(),s.getDate())]}}),r.getTime()<e&&d.push({name:"This month",dates:function(){return[new Date(s.getFullYear(),s.getMonth(),1),s]}}),r.getTime()<a.getTime()&&d.push({name:"Last month",dates:function(){let t=a,e=moment().month(s.getMonth()-1).endOf("month")._d;return 0===s.getMonth()&&(t=moment().year(s.getFullYear()-1).month(11).startOf("month")._d,e=moment().year(s.getFullYear()-1).month(11).endOf("month")._d),[t,e]}}),r.getTime()<o.getTime()&&d.push({name:"This Year",dates:function(){const t=moment().startOf("year")._d;return t.getTime()<r.getTime()?[r,s]:[t,s]}}),r.getTime()<n.getTime()&&d.push({name:"Last Year",dates:function(){return[moment().year(s.getFullYear()-1).month(0).startOf("month")._d,moment().year(s.getFullYear()-1).month(11).endOf("month")._d]}})}d.push({name:"All time",dates:function(){return[r,s]}});var t={separator:" to ",autoClose:!0,setValue:function(t,e,a){n.find("#dlm_start_date").val(e),n.find("#dlm_end_date").val(a)},inline:!0,alwaysOpen:!0,container:"#dlm_date_range_picker",endDate:new Date,startDate:r,showShortcuts:!0,shortcuts:null,customShortcuts:d};n.dateRangePicker(t).on("datepicker-change",(t,e)=>{var a,o;e.date1&&e.date2&&(a=e.date1.toLocaleDateString(void 0,{year:"numeric",month:"short",day:"2-digit"}),o=e.date2.toLocaleDateString(void 0,{year:"numeric",month:"short",day:"2-digit"}),n.parent().find("span.date-range-info").text(a+" to "+o)),this.createDataOnDate(e.date1,e.date2),this.dlmCreateChart(this.stats.chartStats,this.chartContainer),this.dlmDownloadsSummary(),n.data("dateRangePicker").close()})}}hideDatepicker(){this.datePicker.opened=!1,jQuery(this.datePickerContainer).find("#dlm_date_range_picker").remove()}toggleDatepicker(t){t.stopPropagation(),this.datePicker.opened?this.hideDatepicker():this.displayDatepicker()}setTotalDownloads(t){jQuery(".dlm-reports-block-summary li#total span").html(t)}setDailyAverage(t){jQuery(".dlm-reports-block-summary li#average span").html(t)}setMostDownloaded(t){jQuery(".dlm-reports-block-summary li#popular span").html(t)}setTodayDownloads(){let t=0;Object.keys(dlmReportsStats).length<=0||dlmReportsStats[dlmReportsStats.length-1].date===this.createDateElement(new Date)&&(t=Object.values(JSON.parse(dlmReportsStats[dlmReportsStats.length-1].download_ids)).reduce((t,e)=>t+e.downloads,0)),jQuery(".dlm-reports-block-summary li#today span").html(t)}setTopDownloads(o=0,t=!1){const e=jQuery("#total_downloads_table");if(e.empty(),this.mostDownloaded&&!0!==t){var n=jQuery(document.createElement("table"));n.attr("cellspacing",0).attr("cellpadding",0).attr("border",0);t=document.createElement("tr");const a=document.createElement("th");a.innerHTML="#number",t.appendChild(a);const d=document.createElement("th");d.innerHTML="ID",t.appendChild(d);const i=document.createElement("th");i.innerHTML="Title",t.appendChild(i);const l=document.createElement("th");l.innerHTML="Downloads",t.appendChild(l),n.append(t);var r=JSON.parse(JSON.stringify(this.mostDownloaded)).slice(15*parseInt(o),15*parseInt(o+1));for(let a=0;a<r.length;a++){var s=document.createElement("tr");for(let e=0;e<4;e++){let t=document.createElement("td");0===e?t.innerHTML=parseInt(15*o)+a+1:1===e?t.innerHTML=r[a].id:2===e?t.innerHTML='<a href="'+dlm_admin_url+"post.php?post="+r[a].id+'&action=edit" target="_blank">'+r[a].title+"</a>":t.innerHTML=r[a].downloads,s.appendChild(t)}n.append(s)}e.append(n),e.find(".dlm-reports-placeholder-no-data").remove(),15<this.mostDownloaded.length?e.parent().find("#downloads-block-navigation button").removeClass("hidden"):e.parent().find("#downloads-block-navigation button").addClass("hidden")}}handleTopDownloads(){const s=this;jQuery("#downloads-block-navigation").on("click","button",function(){let t=jQuery(this).parents("#total_downloads_table_wrapper"),e=t.find("#total_downloads_table").attr("data-page"),a=t.find("#total_downloads_table table"),o=jQuery(this),n=parseInt(e)+1,r=0!==e?parseInt(e)-1:0;t.find("#total_downloads_table").css("height",a.height()+30),o.attr("disabled","disabled"),"load-more"===o.data("action")?(t.find("#total_downloads_table").attr("data-page",n),s.setTopDownloads(n),jQuery("#downloads-block-navigation").find("button").removeAttr("disabled")):0!==parseInt(e)&&(t.find("#total_downloads_table").attr("data-page",r),s.setTopDownloads(r),1!==parseInt(e)&&jQuery("#downloads-block-navigation").find("button").removeAttr("disabled"))})}tabNagivation(){jQuery(document).on("click",".dlm-reports .dlm-insights-tab-navigation > li",function(){const t=jQuery(this),e=jQuery(".dlm-reports .dlm-insights-tab-navigation > li").not(t),a=jQuery('div.dlm-insights-tab-navigation__content[data-id="'+t.attr("id")+'"]'),o=jQuery("div.dlm-insights-tab-navigation__content").not(a);t.hasClass("active")||(t.addClass("active"),e.removeClass("active"),a.addClass("active"),o.removeClass("active"))})}init(){const e=this;e.dlmCreateChart(this.stats.chartStats,this.chartContainer),e.dlmDownloadsSummary(),e.datePickerContainer.addEventListener("click",e.toggleDatepicker.bind(this)),e.setTodayDownloads(),e.handleTopDownloads(),e.tabNagivation(),jQuery(document).on("click","body",function(t){t.stopPropagation(),0<jQuery(e.datePickerContainer).find("#dlm_date_range_picker").length&&e.hideDatepicker()})}async fetchData(){const t=await fetch(dlmReportsAPI);this.reportsData=await t.json()}}