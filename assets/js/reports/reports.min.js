jQuery(function(t){dlmReports="",dlmReportsStats="",dlmUsersStats="",new DLM_Reports});class DLM_Reports{constructor(){this.chartContainer=document.getElementById("total_downloads_chart");const t=this.chartContainer.getContext("2d");this.chartColors={purple:{default:"rgba(149, 76, 233, 1)",half:"rgba(149, 76, 233, 0.75)",quarter:"rgba(149, 76, 233, 0.5)",zero:"rgba(149, 76, 233, 0.05)"},blue:{default:"rgba(67, 56, 202, 1)",half:"rgba(67, 56, 202, 0.75)",quarter:"rgba(67, 56, 202, 0.5)",zero:"rgba(67, 56, 202, 0.05)"},indigo:{default:"rgba(80, 102, 120, 1)",quarter:"rgba(80, 102, 120, 0.5)"}},this.chartGradient=t.createLinearGradient(0,25,0,300),this.chartGradient.addColorStop(0,this.chartColors.blue.half),this.chartGradient.addColorStop(.45,this.chartColors.blue.quarter),this.chartGradient.addColorStop(1,this.chartColors.blue.zero),this.datePickerContainer=document.getElementById("dlm-date-range-picker"),dlmReports=this.fetchReportsData()}init(){const e=this;e.dlmCreateChart(this.stats.chartStats,this.chartContainer),e.dlmDownloadsSummary(),e.datePickerContainer.addEventListener("click",e.toggleDatepicker.bind(this)),e.setTodayDownloads(),e.handleTopDownloads(),e.tabNagivation(),e.setLoggedInDownloads(),e.setLoggedOutDownloads(),e.createUserRelatedData(),e.setMostActiveUser(),jQuery(document).on("click","body",function(t){t.stopPropagation(),0<jQuery(e.datePickerContainer).find("#dlm_date_range_picker").length&&e.hideDatepicker()})}getDates(t,e){const a=[];let o=t;for(;o<=e;)a[this.createDateElement(o)]=0,o=this.getNextDay(o);return a}getMonths(t){const e=[];return Object.keys(t).map(t=>{t=t.substring(0,7);void 0===e[t]&&(e[t]=0)}),e}getDoubleMonths(t){const e=[],a=Object.keys(t)[0],o=Object.keys(t)[Object.keys(t).length-1];let s=0,n=a.substring(0,7),r=o.substring(0,7);return Object.keys(t).map(t=>{t=t.substring(0,7);n!==t&&r!==t&&(n=t,s++),void 0===e[t]&&0==s%2&&(e[t]=0)}),e}getWeeks(t){const a=[];return Object.keys(t).map(t=>{let e;e=15<moment(t).date()?t.substring(0,7)+"-15":t.substring(0,7)+"-1",void 0===a[e]&&(a[e]=0)}),a}getNextDay(t){const e=new Date(t);return e.setDate(t.getDate()+1),e}createDateElement(t){var e=(t.getMonth()+1<10?"0":"")+(t.getMonth()+1);return t.getFullYear()+"-"+e+"-"+("0"+t.getDate()).slice(-2)}createDataOnDate(t,e){const r=this;let a,o,s,d,l;if(r.reportsData="undefined"!=typeof dlmReportsStats?JSON.parse(JSON.stringify(dlmReportsStats)):{},void 0!==t&&t)a=r.createDateElement(new Date(t));else{const h=new Date;h.setDate(h.getDate()-30),a=r.createDateElement(h)}if(void 0!==e&&e)o=r.createDateElement(new Date(e));else{const u=new Date;u.setDate(u.getDate()+1),o=r.createDateElement(u)}s=moment(o,"YYYY-MM-DD").month()-moment(a,"YYYY-MM-DD").month(),0==moment(o,"YYYY-MM-DD").year()-moment(a,"YYYY-MM-DD").year()&&-6<s&&s<6?r.chartType=1<s||s<-1?"weeks":"day":s<=0?r.chartType="month":r.chartType="months";let i=r.getDates(new Date(a),new Date(o)),m=r.getMonths(i),c=r.getDoubleMonths(i),p=r.getWeeks(i);Object.values(r.reportsData).forEach((a,t)=>{var e=JSON.parse(a.download_ids);if(void 0!==i[a.date])switch(r.chartType){case"months":d=a.date.substring(0,7);const o=parseInt(a.date.substring(5,7)),s=a.date.substring(0,5),n=6<(o-1).length?s+(o-1):s+"0"+(o-1);Object.values(e).forEach((t,e)=>{void 0===c[d]?void 0!==c[n]&&(c[n]=c[n]+t.downloads):c[d]=c[d]+t.downloads}),l=c;break;case"month":d=a.date.substring(0,7),Object.values(e).forEach((t,e)=>{m[d]=void 0!==m[d]?m[d]+t.downloads:t.downloads}),l=m;break;case"weeks":d=15<moment(a.date).date()?a.date.substring(0,7)+"-15":a.date.substring(0,7)+"-1",Object.values(e).forEach((t,e)=>{p[d]=void 0!==p[d]?p[d]+t.downloads:t.downloads}),l=p;break;case"day":Object.values(e).forEach((t,e)=>{i[a.date]=i[a.date]+t.downloads}),l=i}else delete r.reportsData[t]});t=Object.keys(i).length,e=Object.keys(i).findIndex(t=>a===t);let n=Object.keys(i).findIndex(t=>o===t);-1!==e||-1!==n?(-1===n&&(n=t),r.stats={chartStats:Object.assign({},l),summaryStats:r.reportsData,daysLength:t}):r.stats={chartStats:Object.assign({},l),summaryStats:!1,daysLength:t}}dlmCreateChart(n,t){if(n&&t){const r=this,a=Chart.getChart("total_downloads_chart");void 0!==a&&a.destroy();var e=[{label:"Downloads",color:"#27ae60",data:n,type:"line",fill:!0,backgroundColor:r.chartGradient,pointBackgroundColor:r.chartColors.blue.default,pointHoverBackgroundColor:"#fff",borderColor:r.chartColors.blue.default,pointBorderWidth:1,lineTension:.3,borderWidth:1,pointRadius:3,elements:{line:{borderColor:"#2ecc71",borderWidth:1},point:{radius:4,hoverRadius:4,pointStyle:"circle"}}}];r.chart=new Chart(t,{title:"",data:{datasets:e},height:450,is_series:1,options:{aspectRatio:5,animation:!1,scales:{x:{grid:{display:!1},ticks:{callback:t=>{let e="";var a=Object.keys(n)[t],o=Object.keys(n)[Object.keys(n).length-1],s=moment(o).month(moment(o).month()-1).format("YYYY-M");return e="undefined"!==r.chartType&&"months"===r.chartType?(t=moment(Object.keys(n)[t]).month())<11?a===s?moment(a).format("MMM, YYYY"):moment(a).format("MMM")+" - "+moment(a).month(t+1).format("MMM")+moment(a).format(", YYYY"):a===s||a===o?moment(a).format("MMM, YYYY"):moment(a).format("MMM")+moment(a).format(" YYYY")+" - "+moment(a).month(t+1).format("MMM")+moment(a).month(t+1).format(", YYYY"):"undefined"!==r.chartType&&"months"===r.chartType?moment(a).format("MMMM, YYYY"):moment(a).format("D MMM"),e}}},y:{grid:{drawBorder:!1}}},normalized:!0,parsing:{xAxisKey:"x",yAxisKey:"y"},plugins:{tooltip:{enabled:!1,external:r.externalTooltipHandler.bind(r,this)},legend:{display:!1}}}})}}dlmDownloadsSummary(){let a={},o=0;if(!1===this.stats||!1===this.stats.summaryStats||Object.keys(this.stats.summaryStats).length<=0)return this.setTotalDownloads(0),this.setDailyAverage(0),this.setMostDownloaded("--"),void this.setTopDownloads(0,!0);this.stats.summaryStats.forEach(t=>{t=JSON.parse(t.download_ids),Object.entries(t).forEach(([t,e])=>{o+=e.downloads,a[t]=void 0===a[t]?{downloads:e.downloads,title:e.title,id:t}:{downloads:a[t].downloads+e.downloads,title:e.title,id:t}})}),this.mostDownloaded=Object.values(a).sort((t,e)=>t.downloads-e.downloads).reverse(),this.setTotalDownloads(o),this.setDailyAverage((o/parseInt(this.stats.daysLength)).toFixed(0)),this.setMostDownloaded(this.mostDownloaded[0].title),this.setTopDownloads()}createDatepicker(){const t=new Date;let e=t.getDate()-1,a=t.getMonth()+1,o=a-1;var s=t.getFullYear();e<10&&(e="0"+e),a<10&&(a="0"+a),o<10&&(o="0"+o);var n=s+"-"+a+"-"+e,r=s+"-"+o+"-"+e,d=jQuery("<div>").addClass("dlm_rdrs_overlay"),s=jQuery("<div>").attr("id","dlm_date_range_picker");return this.startDateInput=jQuery("<input>").attr("type","hidden").attr("id","dlm_start_date").attr("value",r),this.endDateInput=jQuery("<input>").attr("type","hidden").attr("id","dlm_end_date").attr("value",n),d.append(s).append(this.startDateInput).append(this.endDateInput),d}displayDatepicker(){if(!this.datePicker.opened){this.datePicker.opened=!0;let s=this.createDatepicker();const n=0<Object.keys(dlmReportsStats).length?new Date(dlmReportsStats[0].date):new Date,r=new Date;jQuery(this.datePickerContainer).append(s);const d=[];if(n.getTime()!==r.getTime()){let t=new Date,a=moment().month(r.getMonth()-1).startOf("month")._d,e=new Date(r.getFullYear(),r.getMonth(),1),o=moment().startOf("year")._d,s=moment().year(r.getFullYear()-1).month(0).startOf("month")._d;t=t.setDate(t.getDate()-6),n.getTime()<t&&d.push({name:"Last 7 Days",dates:function(){return[new Date(r.getFullYear(),r.getMonth(),r.getDate()-7),new Date(r.getFullYear(),r.getMonth(),r.getDate())]}}),n.getTime()<e&&d.push({name:"This month",dates:function(){return[new Date(r.getFullYear(),r.getMonth(),1),r]}}),n.getTime()<a.getTime()&&d.push({name:"Last month",dates:function(){let t=a,e=moment().month(r.getMonth()-1).endOf("month")._d;return 0===r.getMonth()&&(t=moment().year(r.getFullYear()-1).month(11).startOf("month")._d,e=moment().year(r.getFullYear()-1).month(11).endOf("month")._d),[t,e]}}),n.getTime()<o.getTime()&&d.push({name:"This Year",dates:function(){const t=moment().startOf("year")._d;return t.getTime()<n.getTime()?[n,r]:[t,r]}}),n.getTime()<s.getTime()&&d.push({name:"Last Year",dates:function(){return[moment().year(r.getFullYear()-1).month(0).startOf("month")._d,moment().year(r.getFullYear()-1).month(11).endOf("month")._d]}})}d.push({name:"All time",dates:function(){return[n,r]}});var t={separator:" to ",autoClose:!0,setValue:function(t,e,a){s.find("#dlm_start_date").val(e),s.find("#dlm_end_date").val(a)},inline:!0,alwaysOpen:!0,container:"#dlm_date_range_picker",endDate:new Date,startDate:n,showShortcuts:!0,shortcuts:null,customShortcuts:d};s.dateRangePicker(t).on("datepicker-change",(t,e)=>{var a,o;e.date1&&e.date2&&(a=e.date1.toLocaleDateString(void 0,{year:"numeric",month:"short",day:"2-digit"}),o=e.date2.toLocaleDateString(void 0,{year:"numeric",month:"short",day:"2-digit"}),s.parent().find("span.date-range-info").text(a+" to "+o)),this.createDataOnDate(e.date1,e.date2),this.dlmCreateChart(this.stats.chartStats,this.chartContainer),this.dlmDownloadsSummary(),s.data("dateRangePicker").close()})}}hideDatepicker(){this.datePicker.opened=!1,jQuery(this.datePickerContainer).find(".dlm_rdrs_overlay").remove()}toggleDatepicker(t){t.stopPropagation(),this.datePicker.opened?this.hideDatepicker():this.displayDatepicker()}setTotalDownloads(t){jQuery(".dlm-reports-block-summary li#total span").html(t.toLocaleString())}setDailyAverage(t){jQuery(".dlm-reports-block-summary li#average span").html(t.toLocaleString())}setMostDownloaded(t){jQuery(".dlm-reports-block-summary li#popular span").html(t)}setTodayDownloads(){let t=0;Object.keys(dlmReportsStats).length<=0?jQuery(".dlm-reports-block-summary li#today span").html(t.toLocaleString()):(dlmReportsStats[dlmReportsStats.length-1].date===this.createDateElement(new Date)&&(t=Object.values(JSON.parse(dlmReportsStats[dlmReportsStats.length-1].download_ids)).reduce((t,e)=>t+e.downloads,0)),jQuery(".dlm-reports-block-summary li#today span").html(t))}setTopDownloads(s=0,a=!1){const o=jQuery("#total_downloads_table");if(o.empty(),o.parent().addClass("empty"),this.mostDownloaded&&!0!==a){let t=document.createElement("div");t.className="dlm-reports-top-downloads";let e=document.createElement("div");e.className="dlm-reports-top-downloads__header";const r=document.createElement("div");r.className="dlm-reports-header-left";const d=document.createElement("label");d.appendChild(document.createTextNode("Title")),r.appendChild(d),e.appendChild(r);const l=document.createElement("div");l.className="dlm-reports-header-right";const i=document.createElement("label");i.appendChild(document.createTextNode("Downloads")),l.appendChild(i),e.appendChild(l),t.append(e);const m=JSON.parse(JSON.stringify(this.mostDownloaded)).slice(10*parseInt(s),10*parseInt(s+1));for(let o=0;o<m.length;o++){const c=document.createElement("div");c.className="dlm-reports-top-downloads__line";var n=100*m[o].downloads/this.mostDownloaded[0].downloads;let a=document.createElement("span");a.className="dlm-reports-top-downloads__overflower",a.style.width=parseInt(n)+"%";for(let e=0;e<3;e++){let t=document.createElement("div");t.setAttribute("data-id",e),0===e?t.innerHTML='<span class="dlm-listing-position">'+(parseInt(10*s)+o+1)+".</span>":1===e?(t.innerHTML='<a href="'+dlm_admin_url+"post.php?post="+m[o].id+'&action=edit" title="Click to edit download: '+m[o].title+'" target="_blank">'+m[o].title+"</a>",t.prepend(a)):t.innerHTML=m[o].downloads.toLocaleString(),c.appendChild(t)}t.append(c)}a=o.parent().find(".dlm-reports-placeholder-no-data");o.parent().removeClass("empty"),o.remove(a).append(t),10<this.mostDownloaded.length?o.parent().find("#downloads-block-navigation button").removeClass("hidden"):o.parent().find("#downloads-block-navigation button").addClass("hidden")}}handleTopDownloads(){const d=this;jQuery("#downloads-block-navigation").on("click","button",function(){let t=jQuery(this).parents("#total_downloads_table_wrapper"),e=t.find("#total_downloads_table").attr("data-page"),a=(t.find("#total_downloads_table table"),jQuery(this)),o=parseInt(e)+1,s=0!==e?parseInt(e)-1:0,n=jQuery("#downloads-block-navigation").find("button").first(),r=jQuery("#downloads-block-navigation").find("button").last();a.attr("disabled","disabled"),"load-more"===a.data("action")?(t.find("#total_downloads_table").attr("data-page",o),d.setTopDownloads(o),Math.ceil(d.mostDownloaded.length/10)>o+1&&r.removeAttr("disabled"),n.removeAttr("disabled")):0!==parseInt(e)&&(t.find("#total_downloads_table").attr("data-page",s),d.setTopDownloads(s),1!==parseInt(e)&&n.removeAttr("disabled"),r.removeAttr("disabled"))})}tabNagivation(){jQuery(document).on("click",".dlm-reports .dlm-insights-tab-navigation > li",function(){const t=jQuery(this),e=jQuery(".dlm-reports .dlm-insights-tab-navigation > li").not(t),a=jQuery('div.dlm-insights-tab-navigation__content[data-id="'+t.attr("id")+'"]'),o=jQuery("div.dlm-insights-tab-navigation__content").not(a);t.hasClass("active")||(t.addClass("active"),e.removeClass("active"),a.addClass("active"),o.removeClass("active"))})}async fetchReportsData(){const t=document.querySelector(".dlm-loading-data"),e=document.querySelector("#wpbody-content .dlm-reports");try{const a=await fetch(dlmReportsAPI);if(!a.ok){const o=document.createElement("div");o.className="dlm-loading-data";const s=document.createTextNode("Seems like we bumped into an error! "),n=document.createTextNode("Data fetching returned a status text of : "+a.statusText),r=document.createElement("h1"),d=document.createElement("h3");throw r.appendChild(s),d.appendChild(n),o.appendChild(r),o.appendChild(d),e.removeChild(t),e.append(o),new Error("Something went wrong! Reports response did not come OK - "+a.statusText)}dlmReports=await a.json(),dlmReportsStats=dlmReports.download_reports,dlmUsersStats=dlmReports.users_reports,this.reportsData="undefined"!=typeof dlmReportsStats?JSON.parse(JSON.stringify(dlmReportsStats)):{},this.mostDownloaded=!1,this.stats=!1,this.chartType="day",this.createDataOnDate(!1,!1),this.datePicker={opened:!1},e.removeChild(t),this.init()}catch(t){const l=document.createElement("div");l.className="dlm-loading-data",l.appendChild(document.createTextNode("Something went wrong! "+t.message)),e.appendChild(l)}}getOrCreateTooltip(t){let e=t.canvas.parentNode.querySelector("div");if(!e){e=document.createElement("div"),e.className="dlm-canvas-tooltip";const a=document.createElement("div");a.className="dlm-reports-tooltip",e.appendChild(a),t.canvas.parentNode.appendChild(e)}return e}externalTooltipHandler(m,e){const{chart:a,tooltip:c}=e,o=m.getOrCreateTooltip(a);var s=jQuery(o).parent().width();if(0!==c.opacity){if(c.body){const r=c.title||[],p=document.createElement("div");p.className="dlm-reports-tooltip__header",r.forEach(t=>{const e=document.createElement("div");e.className="dlm-reports-tooltip__row";const a=document.createElement("p");a.className="dlm-reports-tooltip__downloads",a.appendChild(document.createTextNode(c.dataPoints[0].formattedValue)),e.appendChild(a);const o=document.createElement("p");o.className="dlm-reports-tooltip__info",o.appendChild(document.createTextNode("Downloads")),e.appendChild(o);const s=document.createElement("p");s.className="dlm-reports-tooltip__date";let n="";var r,d,l,i;n="undefined"!==m.chartType&&"months"===m.chartType?(moment(c.dataPoints[0].label).year(),r=moment(c.dataPoints[0].label).month(),d=Object.keys(m.stats.chartStats)[Object.keys(m.stats.chartStats).length-1],l=moment(d).month(moment(d).month()-1).format("YYYY-M"),i=moment(c.dataPoints[0].label).format("YYYY-M"),r<11?i===l?moment(i).format("MMMM, YYYY"):moment(c.dataPoints[0].label).format("MMM")+" - "+moment(c.dataPoints[0].label).month(r+1).format("MMM")+moment(c.dataPoints[0].label).format(", YYYY"):i===l||i===d?moment(i).format("MMMM, YYYY"):moment(c.dataPoints[0].label).format("MMM")+moment(c.dataPoints[0].label).format(" YYYY")+" - "+moment(c.dataPoints[0].label).month(r+1).format("MMM")+moment(c.dataPoints[0].label).month(r+1).format(", YYYY")):"undefined"!==m.chartType&&"months"===m.chartType?moment(c.dataPoints[0].label).format("MMMM, YYYY"):moment(c.dataPoints[0].label).format("MMMM Do, YY"),s.appendChild(document.createTextNode(n)),e.appendChild(s),p.appendChild(e)});const d=o.querySelector("div.dlm-reports-tooltip");for(;d.firstChild;)d.firstChild.remove();d.appendChild(p)}var{offsetLeft:n,offsetTop:e}=a.canvas;let t={isMargin:!(o.style.opacity=1),left:!1};c.caretX-c.width<0&&(t.isMargin=!0,t.left=!0),n+c.caretX+c.width>s&&(t.isMargin=!0,t.left=!1),t.isMargin?t.left?o.style.left=n+c.width+"px":o.style.left=s-c.width+"px":o.style.left=n+c.caretX+"px",o.style.top=e+c.caretY-o.offsetHeight-10+"px"}else o.style.opacity=0}createUserRelatedData(){const o=this;var t="undefined"!=typeof dlmUsersStats?JSON.parse(JSON.stringify(dlmUsersStats.all)):{};o.userRelatedData={},Object.values(t).forEach((t,e)=>{var a;"0"!==t.user_id&&(a=[t.user_id,t.download_id,t.download_date,t.download_status],t="user_"+t.user_id,void 0!==o.userRelatedData[t]?o.userRelatedData[t].push(a):o.userRelatedData[t]=[a])})}setMostActiveUser(){var t=this.getUserByID(this.getMostActiveID());jQuery(".dlm-reports-block-summary li#most_active_user span").html(this.userToolTipMarkup(t))}getMostActiveID(){return dlmUsersStats.logged_in.reduce((t,e,a)=>parseInt(t.download_number)>parseInt(e.download_number)?t.user_id:parseInt(e.user_id))}getUserByID(a){return Object.values(dlmUsersStats.users).reduce((t,e)=>parseInt(t.id)===parseInt(a)?t:e)}getLoggedInDownloads(){let t=0;return dlmUsersStats.logged_in.length&&(t=dlmUsersStats.logged_in.reduce((t,e)=>parseInt(t.download_number)+parseInt(e.download_number))),t}setLoggedInDownloads(){var t=this.getLoggedInDownloads();jQuery(".dlm-reports-block-summary li#logged_in span").html(t)}setLoggedOutDownloads(){let t=0;dlmUsersStats.logged_out.length&&(t=dlmUsersStats.logged_out[0]),jQuery(".dlm-reports-block-summary li#logged_out span").html(t)}userToolTipMarkup(t){let e='<div class="dlm-user-reports">';return e+='<div class="wpchill-tooltip"><i>[?]</i>',e+='<div class="wpchill-tooltip-content">',e+="<span>User ID: "+t.id+"</span>",t.url.length&&(e+="<span>User URL: "+t.url+"</span>"),e+="<span>User registratio date: "+t.registered+"</span>",t.role.length&&(e+="<span>User role: "+t.role+"</span>"),e+="</div></div>",e+=t.display_name,e+="</div>",e}}