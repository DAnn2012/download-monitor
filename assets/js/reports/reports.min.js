jQuery(function(e){dlmReports="",dlmReportsStats="",dlmUsersStats="",dlmReportsInstance={},new DLM_Reports});class DLM_Reports{constructor(){dlmReportsInstance=this,dlmReportsInstance.chartContainer=document.getElementById("total_downloads_chart");const e=this.chartContainer.getContext("2d");dlmReportsInstance.chartColors={purple:{default:"rgba(149, 76, 233, 1)",threesome:"rgba(149, 76, 233, 0.75)",half:"rgba(149, 76, 233, 0.5)",quarter:"rgba(149, 76, 233, 0.5)",zero:"rgba(149, 76, 233, 0.05)"},blue:{default:"rgba(67, 56, 202, 1)",threesome:"rgba(67, 56, 202, 0.75)",half:"rgba(67, 56, 202, 0.5)",quarter:"rgba(67, 56, 202, 0.25)",zero:"rgba(67, 56, 202, 0.05)"},green:{default:"rgba(00, 255, 00, 1)",threesome:"rgba(00, 255, 00, 0.75)",half:"rgba(00, 255, 00, 0.5)",quarter:"rgba(00, 255, 00, 0.25)",zero:"rgba(67, 56, 202, 0.05)"}},dlmReportsInstance.chartGradient=e.createLinearGradient(0,25,0,300),dlmReportsInstance.chartGradient.addColorStop(0,this.chartColors.blue.half),dlmReportsInstance.chartGradient.addColorStop(.45,this.chartColors.blue.quarter),dlmReportsInstance.chartGradient.addColorStop(1,this.chartColors.blue.zero),dlmReportsInstance.chartCompareGradient=e.createLinearGradient(0,25,0,300),dlmReportsInstance.chartCompareGradient.addColorStop(0,this.chartColors.green.half),dlmReportsInstance.chartCompareGradient.addColorStop(.45,this.chartColors.green.quarter),dlmReportsInstance.chartCompareGradient.addColorStop(1,this.chartColors.green.zero),dlmReportsInstance.datePickerContainer=document.getElementById("dlm-date-range-picker"),dlmReportsInstance.compareDatePickerContainer=document.getElementById("dlm-date-range-picker__compare"),dlmReportsInstance.dataSets=[],dlmReports=this.fetchReportsData()}async fetchReportsData(){const e=document.querySelector(".dlm-loading-data"),t=document.querySelector("#wpbody-content .dlm-reports");try{const o=await fetch(dlmReportsAPI);if(!o.ok){const s=document.createElement("div");s.className="dlm-loading-data";const r=document.createTextNode("Seems like we bumped into an error! "),d=document.createTextNode("Data fetching returned a status text of : "+o.statusText),l=document.createElement("h1"),c=document.createElement("h3");throw l.appendChild(r),c.appendChild(d),s.appendChild(l),s.appendChild(c),t.removeChild(e),t.append(s),new Error("Something went wrong! Reports response did not come OK - "+o.statusText)}var a,n;dlmReports=await o.json(),dlmReportsStats=dlmReports.download_reports,dlmUsersStats=dlmReports.users_reports,dlmReportsInstance.reportsData="undefined"!=typeof dlmReportsStats?JSON.parse(JSON.stringify(dlmReportsStats)):{},dlmReportsInstance.userDownloads=void 0!==dlmUsersStats.all?JSON.parse(JSON.stringify(dlmUsersStats.all)):{},dlmReportsInstance.mostDownloaded=!1,dlmReportsInstance.stats=!1,dlmReportsInstance.chartType="day",0<window.location.href.indexOf("dlm_time")?(a=0<Object.keys(dlmReportsStats).length?new Date(dlmReportsStats[0].date):new Date,n=new Date,dlmReportsInstance.createDataOnDate(a,n)):dlmReportsInstance.createDataOnDate(!1,!1),dlmReportsInstance.datePicker={opened:!1},dlmReportsInstance.compareDatePicker={opened:!1},t.removeChild(e),dlmReportsInstance.init()}catch(e){const m=document.createElement("div");m.className="dlm-loading-data",m.appendChild(document.createTextNode("Something went wrong! "+e.message)),t.appendChild(m)}}init(){dlmReportsInstance.tabNagivation(),dlmReportsInstance.overViewTab(),dlmReportsInstance.userReportsTab(),dlmReportsInstance.togglePageSettings(),dlmReportsInstance.downloadLog(),jQuery(document).trigger("dlm_reports_init",[dlmReportsInstance])}overViewTab(){dlmReportsInstance.dlmCreateChart(dlmReportsInstance.stats.chartStats,dlmReportsInstance.chartContainer),dlmReportsInstance.dlmDownloadsSummary(),dlmReportsInstance.datePickerContainer.addEventListener("click",dlmReportsInstance.toggleDatepicker.bind(this)),dlmReportsInstance.compareDatePickerContainer.addEventListener("click",dlmReportsInstance.toggleDatepicker.bind(this)),dlmReportsInstance.setTodayDownloads(),dlmReportsInstance.handleTopDownloads(),jQuery(document).on("click","body",function(e){e.stopPropagation(),0<jQuery(dlmReportsInstance.datePickerContainer).find("#dlm_date_range_picker").length&&dlmReportsInstance.hideDatepicker(jQuery(dlmReportsInstance.datePickerContainer),{target:"date"}),0<jQuery(dlmReportsInstance.compareDatePickerContainer).find("#dlm_compare_date_range_picker").length&&dlmReportsInstance.hideDatepicker(jQuery(dlmReportsInstance.compareDatePickerContainer),{target:"compare"})})}userReportsTab(){var e,t;0!==Object.values(dlmUsersStats).length&&(dlmReportsInstance.currentFilters=[],dlmReportsInstance.tempDownloads=null,0<window.location.href.indexOf("dlm_time")?(e=0<Object.keys(dlmReportsStats).length?new Date(dlmReportsStats[0].date):new Date,t=new Date,dlmReportsInstance.logsDataByDate(e,t)):dlmReportsInstance.logsDataByDate(!1,!1),dlmReportsInstance.filterDownloadsAction(),dlmReportsInstance.handleUserDownloads(),dlmReportsInstance.setFilters())}getDates(e,t){const a=[];let n=e;for(;n<=t;)a[this.createDateElement(n)]=0,n=this.getNextDay(n);return a}getMonths(e){const t=[];return Object.keys(e).map(e=>{e=e.substring(0,7);void 0===t[e]&&(t[e]=0)}),t}getDoubleMonths(e){const t=[],a=Object.keys(e)[0],n=Object.keys(e)[Object.keys(e).length-1];let o=0,s=a.substring(0,7),r=n.substring(0,7);return Object.keys(e).map(e=>{e=e.substring(0,7);s!==e&&r!==e&&(s=e,o++),void 0===t[e]&&0==o%2&&(t[e]=0)}),t}getWeeks(e){const a=[];return Object.keys(e).map(e=>{let t;t=15<moment(e).date()?e.substring(0,7)+"-15":e.substring(0,7)+"-1",void 0===a[t]&&(a[t]=0)}),a}getNextDay(e){const t=new Date(e);return t.setDate(e.getDate()+1),t}createDateElement(e){var t=(e.getMonth()+1<10?"0":"")+(e.getMonth()+1);return e.getFullYear()+"-"+t+"-"+("0"+e.getDate()).slice(-2)}getSetDates(e,t){let a,n;if(void 0!==e&&e)a=dlmReportsInstance.createDateElement(new Date(e));else{const o=new Date;o.setDate(o.getDate()-30),a=dlmReportsInstance.createDateElement(o)}if(void 0!==t&&t){let e=new Date(t);e=e.setDate(e.getDate()+1),e=new Date(e),n=dlmReportsInstance.createDateElement(e)}else{const s=new Date;s.setDate(s.getDate()+1),n=dlmReportsInstance.createDateElement(s)}return{startDate:a,endDate:n}}createDataOnDate(e,t){let{startDate:a,endDate:n}={...dlmReportsInstance.getSetDates(e,t)},o,r,d;dlmReportsInstance.reportsData="undefined"!=typeof dlmReportsStats?JSON.parse(JSON.stringify(dlmReportsStats)):{},o=moment(n,"YYYY-MM-DD").month()-moment(a,"YYYY-MM-DD").month(),0==moment(n,"YYYY-MM-DD").year()-moment(a,"YYYY-MM-DD").year()&&-6<o&&o<6?dlmReportsInstance.chartType=1<o||o<-1?"weeks":"day":o<=0?dlmReportsInstance.chartType="month":dlmReportsInstance.chartType="months";let l=dlmReportsInstance.getDates(new Date(a),new Date(n)),c=dlmReportsInstance.getMonths(l),m=dlmReportsInstance.getDoubleMonths(l),i=dlmReportsInstance.getWeeks(l);Object.values(dlmReportsInstance.reportsData).forEach((a,e)=>{var t=JSON.parse(a.download_ids);if(void 0!==l[a.date])switch(dlmReportsInstance.chartType){case"months":r=a.date.substring(0,7);const n=parseInt(a.date.substring(5,7)),o=a.date.substring(0,5),s=6<(n-1).length?o+(n-1):o+"0"+(n-1);Object.values(t).forEach((e,t)=>{void 0===m[r]?void 0!==m[s]&&(m[s]=m[s]+e.downloads):m[r]=m[r]+e.downloads}),d=m;break;case"month":r=a.date.substring(0,7),Object.values(t).forEach((e,t)=>{c[r]=void 0!==c[r]?c[r]+e.downloads:e.downloads}),d=c;break;case"weeks":r=15<moment(a.date).date()?a.date.substring(0,7)+"-15":a.date.substring(0,7)+"-1",Object.values(t).forEach((e,t)=>{i[r]=void 0!==i[r]?i[r]+e.downloads:e.downloads}),d=i;break;case"day":Object.values(t).forEach((e,t)=>{l[a.date]=l[a.date]+e.downloads}),d=l}else delete dlmReportsInstance.reportsData[e]});const s=Object.keys(l);e=s.length,t=s.findIndex(e=>a===e);let p=s.findIndex(e=>n===e);-1!==t||-1!==p?(-1===p&&(p=e),dlmReportsInstance.stats={chartStats:Object.assign({},d),summaryStats:dlmReportsInstance.reportsData,daysLength:e}):dlmReportsInstance.stats={chartStats:Object.assign({},d),summaryStats:!1,daysLength:e}}dlmCreateChart(m,i,p=!1){if(m&&i){let e=Chart.getChart("total_downloads_chart"),t="Downloads",a="#27ae60",n=dlmReportsInstance.chartGradient,o=dlmReportsInstance.chartColors.blue.default,s=dlmReportsInstance.chartColors.blue.default,r="#2ecc71",d="original",l=m;void 0!==e&&e.destroy(),p&&(t="Comparison",a="#00ff00",n=dlmReportsInstance.chartCompareGradient,o=dlmReportsInstance.chartColors.green.default,s=dlmReportsInstance.chartColors.green.default,r="#00ff00",d="comparer",l=Object.values(m)),0<dlmReportsInstance.dataSets.length&&(dlmReportsInstance.dataSets=dlmReportsInstance.dataSets.filter(e=>d!==e.origin)),dlmReportsInstance.dataSets.push({origin:d,label:t,color:a,data:l,type:"line",fill:!0,backgroundColor:n,pointBackgroundColor:o,pointHoverBackgroundColor:"#fff",borderColor:s,pointBorderWidth:1,lineTension:.3,borderWidth:1,pointRadius:3,elements:{line:{borderColor:r,borderWidth:1},point:{radius:4,hoverRadius:4,pointStyle:"circle"}}});m=Object.values(dlmReportsInstance.dataSets).filter(e=>"original"===e.origin);let c=Object.keys(m[0].data);dlmReportsInstance.chart=new Chart(i,{title:"",data:{datasets:dlmReportsInstance.dataSets},height:450,is_series:1,options:{aspectRatio:5,animation:!1,interaction:{mode:"index",intersect:!1},stacked:!1,scales:{x:{grid:{display:!1},ticks:{callback:e=>{let t="";var a=c[e],n=c[c.length-1],o=moment(n).month(moment(n).month()-1).format("YYYY-M");return t="undefined"!==dlmReportsInstance.chartType&&"months"===dlmReportsInstance.chartType?(e=moment(c[e]).month())<11?a===o?moment(a).format("MMM, YYYY"):moment(a).format("MMM")+" - "+moment(a).month(e+1).format("MMM")+moment(a).format(", YYYY"):a===o||a===n?moment(a).format("MMM, YYYY"):moment(a).format("MMM")+moment(a).format(" YYYY")+" - "+moment(a).month(e+1).format("MMM")+moment(a).month(e+1).format(", YYYY"):"undefined"!==dlmReportsInstance.chartType&&"months"===dlmReportsInstance.chartType?moment(a).format("MMMM, YYYY"):moment(a).format("D MMM"),t}}},y:{grid:{drawBorder:!1}}},normalized:!0,parsing:{xAxisKey:"x",yAxisKey:"y"},plugins:{tooltip:{enabled:!1,external:dlmReportsInstance.externalTooltipHandler.bind(dlmReportsInstance,this)},legend:{display:!0}}}})}}dlmDownloadsSummary(){let a={},n=0;if(!1===dlmReportsInstance.stats||!1===this.stats.summaryStats||Object.keys(dlmReportsInstance.stats.summaryStats).length<=0)return this.setTotalDownloads(0),this.setDailyAverage(0),this.setMostDownloaded("--"),void this.setTopDownloads(0,!0);dlmReportsInstance.stats.summaryStats.forEach(e=>{e=JSON.parse(e.download_ids),Object.entries(e).forEach(([e,t])=>{n+=t.downloads,a[e]=void 0===a[e]?{downloads:t.downloads,title:t.title,id:e}:{downloads:a[e].downloads+t.downloads,title:t.title,id:e}})}),dlmReportsInstance.mostDownloaded=Object.values(a).sort((e,t)=>e.downloads-t.downloads).reverse(),dlmReportsInstance.setTotalDownloads(n),dlmReportsInstance.setDailyAverage((n/parseInt(this.stats.daysLength)).toFixed(0)),dlmReportsInstance.setMostDownloaded(this.mostDownloaded[0].title),dlmReportsInstance.setTopDownloads()}createDatepicker(e,t,a){const n=new Date;let o=n.getDate()-1,s=n.getMonth()+1,r=s-1;var d=n.getFullYear();o<10&&(o="0"+o),s<10&&(s="0"+s),r<10&&(r="0"+r);var l=d+"-"+s+"-"+o,c=d+"-"+r+"-"+o,d=jQuery("<div>").addClass("dlm_rdrs_overlay"),a=jQuery("<div>").attr("id",a.replace("#",""));return"date"===t.target?(dlmReportsInstance.startDateInput=jQuery("<input>").attr("type","hidden").attr("id","dlm_start_date").attr("value",c),dlmReportsInstance.endDateInput=jQuery("<input>").attr("type","hidden").attr("id","dlm_end_date").attr("value",l),d.append(a).append(dlmReportsInstance.startDateInput).append(dlmReportsInstance.endDateInput)):(dlmReportsInstance.startCompareDateInput=jQuery("<input>").attr("type","hidden").attr("id","dlm_start_compare_date").attr("value",c),dlmReportsInstance.endCompareDateInput=jQuery("<input>").attr("type","hidden").attr("id","dlm_end_compare_date").attr("value",l),d.append(a).append(dlmReportsInstance.startCompareDateInput).append(dlmReportsInstance.endCompareDateInput)),d}displayDatepicker(e,o){let t="#dlm_date_range_picker";if("date"===o.target){if(dlmReportsInstance.datePicker.opened)return;dlmReportsInstance.datePicker.opened=!0}else{if(dlmReportsInstance.compareDatePicker.opened)return;dlmReportsInstance.compareDatePicker.opened=!0,t="#dlm_compare_date_range_picker"}let s=dlmReportsInstance.createDatepicker(e,o,t);const r=0<Object.keys(dlmReportsStats).length?new Date(dlmReportsStats[0].date):new Date,d=new Date;e.append(s);const l=[];if(r.getTime()!==d.getTime()){let e=new Date,a=moment().month(d.getMonth()-1).startOf("month")._d,t=new Date(d.getFullYear(),d.getMonth(),1),n=moment().startOf("year")._d,o=moment().year(d.getFullYear()-1).month(0).startOf("month")._d;e=e.setDate(e.getDate()-6),r.getTime()<e&&l.push({name:"Last 7 Days",dates:function(){return[new Date(d.getFullYear(),d.getMonth(),d.getDate()-7),new Date(d.getFullYear(),d.getMonth(),d.getDate())]}}),r.getTime()<t&&l.push({name:"This month",dates:function(){return[new Date(d.getFullYear(),d.getMonth(),1),d]}}),r.getTime()<a.getTime()&&l.push({name:"Last month",dates:function(){let e=a,t=moment().month(d.getMonth()-1).endOf("month")._d;return 0===d.getMonth()&&(e=moment().year(d.getFullYear()-1).month(11).startOf("month")._d,t=moment().year(d.getFullYear()-1).month(11).endOf("month")._d),[e,t]}}),r.getTime()<n.getTime()&&l.push({name:"This Year",dates:function(){const e=moment().startOf("year")._d;return e.getTime()<r.getTime()?[r,d]:[e,d]}}),r.getTime()<o.getTime()&&l.push({name:"Last Year",dates:function(){return[moment().year(d.getFullYear()-1).month(0).startOf("month")._d,moment().year(d.getFullYear()-1).month(11).endOf("month")._d]}})}l.push({name:"All time",dates:function(){return[r,d]}});e={separator:" to ",autoClose:!0,setValue:function(e,t,a){"date"===o.target?(s.find("#dlm_start_date").val(t),s.find("#dlm_end_date").val(a)):(s.find("#dlm_start_compare_date").val(t),s.find("#dlm_end_compare_date").val(a))},inline:!0,alwaysOpen:!0,container:t,endDate:new Date,startDate:r,showShortcuts:!0,shortcuts:null,customShortcuts:l};s.dateRangePicker(e).on("datepicker-change",(e,t)=>{var a,n;t.date1&&t.date2&&(a=t.date1.toLocaleDateString(void 0,{year:"numeric",month:"short",day:"2-digit"}),n=t.date2.toLocaleDateString(void 0,{year:"numeric",month:"short",day:"2-digit"}),s.parent().find("span.date-range-info").text(a+" to "+n)),dlmReportsInstance.createDataOnDate(t.date1,t.date2),dlmReportsInstance.dlmCreateChart(dlmReportsInstance.stats.chartStats,dlmReportsInstance.chartContainer,"compare"===o.target),"date"===o.target&&(dlmReportsInstance.dlmDownloadsSummary(),0<Object.values(dlmUsersStats).length&&dlmReportsInstance.logsDataByDate(t.date1,t.date2)),s.data("dateRangePicker").close()})}hideDatepicker(e,t){"date"===t.target?dlmReportsInstance.datePicker.opened=!1:dlmReportsInstance.compareDatePicker.opened=!1,e.find(".dlm_rdrs_overlay").remove()}toggleDatepicker(e){e.stopPropagation();const t=jQuery(e.target).parents(".dlm-reports-header-date-selector");let a={target:"date",object:dlmReportsInstance.datePicker};"dlm-date-range-picker__compare"===t.attr("id")&&(a={target:"compare",object:dlmReportsInstance.compareDatePicker}),"date"===a.target?dlmReportsInstance.datePicker.opened?dlmReportsInstance.hideDatepicker(t,a):(dlmReportsInstance.displayDatepicker(t,a),dlmReportsInstance.hideDatepicker(jQuery(dlmReportsInstance.compareDatePickerContainer),{target:"comparer"})):dlmReportsInstance.compareDatePicker.opened?dlmReportsInstance.hideDatepicker(t,a):(dlmReportsInstance.displayDatepicker(t,a),dlmReportsInstance.hideDatepicker(jQuery(dlmReportsInstance.datePickerContainer),{target:"date"}))}setTotalDownloads(e){jQuery(".dlm-reports-block-summary li#total span").html(e.toLocaleString())}setDailyAverage(e){jQuery(".dlm-reports-block-summary li#average span").html(e.toLocaleString())}setMostDownloaded(e){jQuery(".dlm-reports-block-summary li#popular span").html(e)}setTodayDownloads(){let e=0;Object.keys(dlmReportsStats).length<=0?jQuery(".dlm-reports-block-summary li#today span").html(e.toLocaleString()):(dlmReportsStats[dlmReportsStats.length-1].date===dlmReportsInstance.createDateElement(new Date)&&(e=Object.values(JSON.parse(dlmReportsStats[dlmReportsStats.length-1].download_ids)).reduce((e,t)=>e+t.downloads,0)),jQuery(".dlm-reports-block-summary li#today span").html(e))}setTopDownloads(o=0,a=!1){const n=jQuery("#total_downloads_table");if(n.empty(),n.parent().addClass("empty"),dlmReportsInstance.mostDownloaded&&!0!==a){let e=document.createElement("div");e.className="dlm-reports-top-downloads";let t=document.createElement("div");t.className="dlm-reports-top-downloads__header";const r=document.createElement("div");r.className="dlm-reports-header-left";const d=document.createElement("label");d.appendChild(document.createTextNode("Title")),r.appendChild(d),t.appendChild(r);const l=document.createElement("div");l.className="dlm-reports-header-right";const c=document.createElement("label");c.appendChild(document.createTextNode("Downloads")),l.appendChild(c),t.appendChild(l),e.append(t);const m=JSON.parse(JSON.stringify(dlmReportsInstance.mostDownloaded)).slice(10*parseInt(o),10*parseInt(o+1));for(let n=0;n<m.length;n++){const i=document.createElement("div");i.className="dlm-reports-top-downloads__line";var s=100*m[n].downloads/dlmReportsInstance.mostDownloaded[0].downloads;let a=document.createElement("span");a.className="dlm-reports-top-downloads__overflower",a.style.width=parseInt(s)+"%";for(let t=0;t<3;t++){let e=document.createElement("div");e.setAttribute("data-id",t),0===t?e.innerHTML='<span class="dlm-listing-position">'+(parseInt(10*o)+n+1)+".</span>":1===t?(e.innerHTML='<a href="'+dlm_admin_url+"post.php?post="+m[n].id+'&action=edit" title="Click to edit download: '+m[n].title+'" target="_blank">'+m[n].title+"</a>",e.prepend(a)):e.innerHTML=m[n].downloads.toLocaleString(),i.appendChild(e)}e.append(i)}a=n.parent().find(".dlm-reports-placeholder-no-data");n.parent().removeClass("empty"),n.remove(a).append(e),10<dlmReportsInstance.mostDownloaded.length?n.parent().find("#downloads-block-navigation button").removeClass("hidden"):n.parent().find("#downloads-block-navigation button").addClass("hidden")}}handleTopDownloads(){jQuery("#downloads-block-navigation").on("click","button",function(){let e=jQuery(this).parents("#total_downloads_table_wrapper"),t=e.find("#total_downloads_table"),a=e.find("#total_downloads_table").attr("data-page"),n=e.find("#total_downloads_table table"),o=jQuery(this),s=parseInt(a)+1,r=0!==a?parseInt(a)-1:0,d=jQuery("#downloads-block-navigation").find("button").first(),l=jQuery("#downloads-block-navigation").find("button").last();o.attr("disabled","disabled");var c={data:dlmReportsInstance.mostDownloaded,main_parent:e,offsetHolder:t,offset:a,table:n,link:o,nextPage:s,prevPage:r,prevButton:d,nextButton:l,doAction:dlmReportsInstance.setTopDownloads};dlmReportsInstance.handleSliderNavigation(c)})}handleSliderNavigation(e){const{data:t,offsetHolder:a,offset:n,link:o,nextPage:s,prevPage:r,prevButton:d,nextButton:l,doAction:c}={...e};"load-more"===o.data("action")?(a.attr("data-page",s),c(s),Math.ceil(t.length/10)>s+1&&l.removeAttr("disabled"),d.removeAttr("disabled")):0!==parseInt(n)&&(a.attr("data-page",r),c(r),1!==parseInt(n)&&d.removeAttr("disabled"),l.removeAttr("disabled"))}tabNagivation(){jQuery(document).on("click",".dlm-reports .dlm-insights-tab-navigation > li",function(){const e=jQuery(this),t=jQuery(".dlm-reports .dlm-insights-tab-navigation > li").not(e),a=jQuery('div.dlm-insights-tab-navigation__content[data-id="'+e.attr("id")+'"]'),n=jQuery("div.dlm-insights-tab-navigation__content").not(a);e.hasClass("active")||(e.addClass("active"),t.removeClass("active"),a.addClass("active"),n.removeClass("active"))})}getOrCreateTooltip(e){let t=e.canvas.parentNode.querySelector("div");if(!t){t=document.createElement("div"),t.className="dlm-canvas-tooltip";const a=document.createElement("div");a.className="dlm-reports-tooltip",t.appendChild(a),e.canvas.parentNode.appendChild(t)}return t}externalTooltipHandler(m,t){const{chart:a,tooltip:i}=t,n=m.getOrCreateTooltip(a);var o=jQuery(n).parent().width();if(0!==i.opacity){if(i.body){const r=i.title||[],p=document.createElement("div");p.className="dlm-reports-tooltip__header",r.forEach(e=>{const t=document.createElement("div");t.className="dlm-reports-tooltip__row";const a=document.createElement("p");a.className="dlm-reports-tooltip__downloads",a.appendChild(document.createTextNode(i.dataPoints[0].formattedValue)),t.appendChild(a);const n=document.createElement("p");n.className="dlm-reports-tooltip__info",n.appendChild(document.createTextNode("Downloads")),t.appendChild(n);const o=document.createElement("p");o.className="dlm-reports-tooltip__date";let s="";var r,d,l,c;s="undefined"!==m.chartType&&"months"===m.chartType?(moment(i.dataPoints[0].label).year(),r=moment(i.dataPoints[0].label).month(),d=Object.keys(m.stats.chartStats)[Object.keys(m.stats.chartStats).length-1],l=moment(d).month(moment(d).month()-1).format("YYYY-M"),c=moment(i.dataPoints[0].label).format("YYYY-M"),r<11?c===l?moment(c).format("MMMM, YYYY"):moment(i.dataPoints[0].label).format("MMM")+" - "+moment(i.dataPoints[0].label).month(r+1).format("MMM")+moment(i.dataPoints[0].label).format(", YYYY"):c===l||c===d?moment(c).format("MMMM, YYYY"):moment(i.dataPoints[0].label).format("MMM")+moment(i.dataPoints[0].label).format(" YYYY")+" - "+moment(i.dataPoints[0].label).month(r+1).format("MMM")+moment(i.dataPoints[0].label).month(r+1).format(", YYYY")):"undefined"!==m.chartType&&"months"===m.chartType?moment(i.dataPoints[0].label).format("MMMM, YYYY"):moment(i.dataPoints[0].label).format("MMMM Do, YY"),o.appendChild(document.createTextNode(s)),t.appendChild(o),p.appendChild(t)});const d=n.querySelector("div.dlm-reports-tooltip");for(;d.firstChild;)d.firstChild.remove();d.appendChild(p)}var{offsetLeft:s,offsetTop:t}=a.canvas;let e={isMargin:!(n.style.opacity=1),left:!1};i.caretX-i.width<0&&(e.isMargin=!0,e.left=!0),s+i.caretX+i.width>o&&(e.isMargin=!0,e.left=!1),e.isMargin?e.left?n.style.left=s+i.width+"px":n.style.left=o-i.width+"px":n.style.left=s+i.caretX+"px",n.style.top=t+i.caretY-n.offsetHeight-10+"px"}else n.style.opacity=0}createUserRelatedData(){dlmReportsInstance.userRelatedData=[],Object.values(dlmReportsInstance.userDownloads).forEach((e,t)=>{var a;"0"!==e.user_id&&(a=[e.user_id,e.download_id,e.download_date,e.download_status],e="user_"+e.user_id,void 0!==dlmReportsInstance.userRelatedData[e]?dlmReportsInstance.userRelatedData[e].push(a):dlmReportsInstance.userRelatedData[e]=[a])})}logsDataByDate(e,t){var{startDate:e,endDate:t}={...dlmReportsInstance.getSetDates(e,t)};dlmReportsInstance.userDownloads=JSON.parse(JSON.stringify(dlmUsersStats.all));const a=new Date(e).getTime(),n=new Date(t).getTime();dlmReportsInstance.userDownloads=dlmReportsInstance.userDownloads.filter((e,t)=>{e=new Date(e.download_date).getTime();return!(e<a||e>n)}),dlmReportsInstance.createUserRelatedData(),dlmReportsInstance.filterDownloads(),dlmReportsInstance.setMostActiveUser(),dlmReportsInstance.setLoggedOutDownloads(),dlmReportsInstance.setLoggedInDownloads()}setMostActiveUser(){var e=dlmReportsInstance.getUserByID(dlmReportsInstance.getMostActiveID()[0]);jQuery(".dlm-reports-block-summary li#most_active_user span").html(dlmReportsInstance.userToolTipMarkup(e))}getMostActiveID(){return Object.values(dlmReportsInstance.userRelatedData).length?Object.values(dlmReportsInstance.userRelatedData).reduce((e,t,a)=>parseInt(e.length)>parseInt(t.length)?e:t):0}getUserByID(a){return a&&"0"!==a?Object.values(dlmUsersStats.users).reduce((e,t)=>parseInt(e.id)===parseInt(a)?e:parseInt(t.id)===parseInt(a)?t:null):null}getLoggedInDownloads(){return Object.values(dlmReportsInstance.userRelatedData).length?1<Object.values(dlmReportsInstance.userRelatedData).length?Object.values(dlmReportsInstance.userRelatedData).reduce((e,t)=>parseInt(e)+parseInt(t.length),0):Object.values(dlmReportsInstance.userRelatedData)[0].length:0}setLoggedInDownloads(){var e=dlmReportsInstance.getLoggedInDownloads();jQuery(".dlm-reports-block-summary li#logged_in span,#total_downloads_summary_wrapper .dlm-reports-logged-in").html(e)}getLoggedOutDownloads(){return dlmReportsInstance.userDownloads.length-dlmReportsInstance.getLoggedInDownloads()}setLoggedOutDownloads(){var e=dlmReportsInstance.getLoggedOutDownloads();jQuery(".dlm-reports-block-summary li#logged_out span,#total_downloads_summary_wrapper .dlm-reports-logged-out").html(e)}userToolTipMarkup(e){let t='<div class="dlm-user-reports">';return t+='<div class="wpchill-tooltip"><i>[?]</i>',t+='<div class="wpchill-tooltip-content">',t+="<span>User ID: "+(null!==e?e.id:"--")+"</span>","object"!=typeof e&&e.url.length&&(t+="<span>User URL: "+(null!==e?e.url:"--")+"</span>"),t+="<span>User registration date: "+(null!==e?e.registered:"--")+"</span>",null!==e&&e.role.length&&(t+="<span>User role: "+e.role+"</span>"),t+="</div></div>",t+=null!==e?e.display_name:"--",t+="</div>",t}setUserDownloads(a=0,e=!1){const o=jQuery("#users_download_log");if(o.empty(),o.parent().addClass("empty"),!0!==e){let e=document.createElement("div");e.className="dlm-reports-top-downloads";let t=document.createElement("div");t.className="dlm-reports-top-downloads__header";const d=document.createElement("div");d.className="dlm-reports-header-user";const l=document.createElement("label");l.appendChild(document.createTextNode("User")),d.appendChild(l),t.appendChild(d);const c=document.createElement("div");c.className="dlm-reports-header-ip";const m=document.createElement("label");m.appendChild(document.createTextNode("IP")),c.appendChild(m),t.appendChild(c);const i=document.createElement("div");i.className="dlm-reports-header-role";const p=document.createElement("label");p.appendChild(document.createTextNode("Role")),i.appendChild(p),t.appendChild(i);const u=document.createElement("div");u.className="dlm-reports-header-download";const h=document.createElement("label");h.appendChild(document.createTextNode("Download")),u.appendChild(h),t.appendChild(u);const g=document.createElement("div");g.className="dlm-reports-header-status";const I=document.createElement("label");I.appendChild(document.createTextNode("Status")),g.appendChild(I),t.appendChild(g);const R=document.createElement("div");R.className="dlm-reports-header-date";const D=document.createElement("label");D.appendChild(document.createTextNode("Download date")),R.appendChild(D),t.appendChild(R);const w=document.createElement("div");w.className="dlm-reports-header-action";const y=document.createElement("label");y.appendChild(document.createTextNode("Action")),w.appendChild(y),t.appendChild(w),e.append(t);let n=[];if(n=(null!==dlmReportsInstance.tempDownloads?JSON.parse(JSON.stringify(dlmReportsInstance.tempDownloads)):JSON.parse(JSON.stringify(dlmReportsInstance.userDownloads))).slice(10*parseInt(a),10*parseInt(a+1)),n.length)for(let a=0;a<n.length;a++){const f=document.createElement("div");f.className="dlm-reports-top-downloads__line";for(let t=0;t<7;t++){let e=document.createElement("div");switch(e.setAttribute("data-id",t),t){case 0:e.innerHTML=dlmReportsInstance.userToolTipMarkup(dlmReportsInstance.getUserByID(n[a].user_id.toString()));break;case 1:e.innerHTML="<p>"+n[a].user_ip+"</p>";break;case 2:var s=dlmReportsInstance.getUserByID(n[a].user_id.toString());e.innerHTML="<p>"+(null!==s&&null!==s.role?s.role:"--")+"</p>";break;case 3:var r=dlmReportsInstance.getDownloadByID(n[a].download_id);e.innerHTML='<p><a href="'+dlm_admin_url+"post.php?post="+n[a].download_id+'&action=edit" title="Click to edit download: '+r.title+'" target="_blank">'+r.title+"</a></p>";break;case 4:e.innerHTML='<p><span class="dlm-reports-top-downloads__download_status '+n[a].download_status+'">'+n[a].download_status+"</span></p>";break;case 5:e.innerHTML="<p>"+n[a].download_date+"</p>";break;case 6:r="0"!==n[a].user_id?'<a href="'+dlm_admin_url+"user-edit.php?user_id="+n[a].user_id+'" target="_blank">Edit user</a>':"--";e.innerHTML="<p>"+r+"</p>"}f.appendChild(e)}e.append(f)}a=o.parent().find(".dlm-reports-placeholder-no-data");o.parent().removeClass("empty"),o.remove(a).append(e),10<dlmReportsInstance.userDownloads.length?o.parent().find("#user-downloads-block-navigation button").removeClass("hidden"):o.parent().find("#user-downloads-block-navigation button").addClass("hidden")}}getDownloadByID(a){return dlmReportsInstance.mostDownloaded.reduce((e,t)=>null!==e&&a===e.id?e:a===t.id?t:null,{id:0})}handleUserDownloads(){jQuery("#user-downloads-block-navigation").on("click","button",function(){let e=jQuery(this).parents("#users_downloads_table_wrapper"),t=e.find("#users_download_log"),a=e.find("#users_download_log").attr("data-page"),n=e.find("#total_downloads_table table"),o=jQuery(this),s=parseInt(a)+1,r=0!==a?parseInt(a)-1:0,d=jQuery("#user-downloads-block-navigation").find("button").first(),l=jQuery("#user-downloads-block-navigation").find("button").last();o.attr("disabled","disabled");var c={data:dlmReportsInstance.tempDownloads,main_parent:e,offsetHolder:t,offset:a,table:n,link:o,nextPage:s,prevPage:r,prevButton:d,nextButton:l,doAction:dlmReportsInstance.setUserDownloads};dlmReportsInstance.handleSliderNavigation(c)})}filterDownloadsAction(){jQuery("#users_downloads_table_wrapper").on("change",".user-downloads-filters select",e=>{const t=jQuery(e.currentTarget).val(),a=jQuery(e.currentTarget).data("type"),n={type:a,on:t};dlmReportsInstance.currentFilters.length&&Object.values(dlmReportsInstance.currentFilters).forEach((e,t)=>{a===e.type&&dlmReportsInstance.currentFilters.splice(t,1)}),""!==t&&dlmReportsInstance.currentFilters.push(n),dlmReportsInstance.filterDownloads()})}filterDownloads(){dlmReportsInstance.tempDownloads=JSON.parse(JSON.stringify(dlmReportsInstance.userDownloads)),dlmReportsInstance.currentFilters.length&&dlmReportsInstance.currentFilters.forEach(t=>{dlmReportsInstance.tempDownloads=dlmReportsInstance.tempDownloads.filter(e=>t.on===e[t.type])}),dlmReportsInstance.setUserDownloads()}setFilters(){let t="";Object.values(dlmUsersStats.users).forEach(e=>{t+='<option value="'+e.id+'">'+e.display_name+"</option>"}),jQuery("#dlm-filter-by-user").append(t),jQuery(document).trigger("dlm_set_users_filter",[dlmReportsInstance,dlmUsersStats])}togglePageSettings(){jQuery("#dlm-toggle-settings").on("click",function(e){e.stopPropagation(),jQuery(this).find(".dlm-toggle-settings__settings").toggleClass("display")}),jQuery(".dlm-toggle-settings__settings").on("click",function(e){e.stopPropagation()}),jQuery("html,body").on("click",function(){jQuery(this).find(".dlm-toggle-settings__settings").removeClass("display")}),jQuery(document).on("change",".wpchill-toggle__input",function(e){const t=jQuery(this),a=t.attr("name"),n={action:"dlm_update_report_setting",name:a,checked:t.is(":checked"),_ajax_nonce:dlmReportsNonce};jQuery.post(ajaxurl,n,function(e){switch(a){case"dlm_clear_api_cache":case"dlm_toggle_user_reports":window.location.reload();break;case"dlm_toggle_compare":t.is(":checked")?jQuery("#dlm-date-range-picker__compare").removeClass("disabled"):jQuery("#dlm-date-range-picker__compare").addClass("disabled")}})})}downloadLog(){jQuery("a#dlm-download-log").on("click",function(e){e.preventDefault();e={action:"dlm_download_log",_ajax_nonce:dlmReportsNonce};jQuery.post(ajaxurl,e,function(e){})})}}