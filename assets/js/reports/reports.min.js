jQuery((function(t){new DLM_Reports}));class DLM_Reports{constructor(){this.chartContainer=document.getElementById("total_downloads_chart"),this.chartContainer=document.getElementById("total_downloads_chart");const t=this.chartContainer.getContext("2d");this.chartColors={purple:{default:"rgba(149, 76, 233, 1)",half:"rgba(149, 76, 233, 0.75)",quarter:"rgba(149, 76, 233, 0.5)",zero:"rgba(149, 76, 233, 0.05)"},indigo:{default:"rgba(80, 102, 120, 1)",quarter:"rgba(80, 102, 120, 0.5)"}},this.chartGradient=t.createLinearGradient(0,25,0,300),this.chartGradient.addColorStop(0,this.chartColors.purple.half),this.chartGradient.addColorStop(.45,this.chartColors.purple.quarter),this.chartGradient.addColorStop(1,this.chartColors.purple.zero),this.datePickerContainer=document.getElementById("dlm-date-range-picker"),this.reportsData="undefined"!=typeof dlmReportsStats?JSON.parse(JSON.stringify(dlmReportsStats)):{},this.mostDownloaded=!1,this.stats=!1,this.createDataOnDate(!1,!1),this.datePicker={opened:!1},this.init()}getDates(t,e){const a=[];let n=t;for(;n<=e;)a[this.createDateElement(n)]=0,n=this.getNextDay(n);return a}getNextDay(t){const e=new Date(t);return e.setDate(t.getDate()+1),e}createDateElement(t){return t.getFullYear()+"-"+(t.getMonth()+1)+"-"+t.getDate()}createDataOnDate(t,e){let a,n;if(this.reportsData="undefined"!=typeof dlmReportsStats?JSON.parse(JSON.stringify(dlmReportsStats)):{},void 0!==t&&t)a=this.createDateElement(new Date(t));else{const t=new Date;t.setDate(t.getDate()-30),a=this.createDateElement(t)}if(void 0!==e&&e)n=this.createDateElement(new Date(e));else{const t=new Date;n=this.createDateElement(t)}let o=this.getDates(new Date(a),new Date(n));Object.values(this.reportsData).forEach(((t,e)=>{const a=JSON.parse(t.download_ids);let n=new Date(t.date);const s=this.createDateElement(n);void 0!==o[s]?Object.values(a).forEach(((t,e)=>{o[s]=o[s]+t.downloads})):delete this.reportsData[e]}));const s=Object.keys(o).length;let r=Object.keys(o).findIndex((t=>{let e=new Date(t);return e=this.createDateElement(e),a===e})),d=Object.keys(o).findIndex((t=>{let e=new Date(t);return e=this.createDateElement(e),n===e}));-1!==r||-1!==d?(-1===r&&(r=0),-1===d&&(d=s),this.stats={chartStats:Object.assign({},o),summaryStats:this.reportsData,daysLength:s}):this.stats={chartStats:Object.assign({},o),summaryStats:!1,daysLength:s}}dlmCreateChart(t,e){if(t&&e){const a=Chart.getChart("total_downloads_chart");void 0!==a&&a.destroy();const n=[{label:"Downloads",color:"#27ae60",data:t,type:"line",fill:!0,backgroundColor:this.chartGradient,pointBackgroundColor:this.chartColors.purple.default,borderColor:this.chartColors.purple.default,lineTension:.2,borderWidth:2,pointRadius:3,elements:{line:{borderColor:"#2ecc71",borderWidth:2}}}];this.chart=new Chart(e,{title:"",data:{datasets:n},height:450,show_dots:0,x_axis_mode:"tick",y_axis_mode:"span",is_series:1,options:{aspectRatio:3,animation:!1,scales:{x:{grid:{display:!1}}},normalized:!0,parsing:{xAxisKey:"x",yAxisKey:"y"}}})}}dlmDownloadsSummary(t,e){let a={},n=0;if(!1===this.stats||!1===this.stats.summaryStats||Object.keys(this.stats.summaryStats).length<=0)return this.setTotalDownloads(0),this.setDailyAverage(0),this.setMostDownloaded("--"),void this.setTopDownloads(0,!0);this.stats.summaryStats.forEach((t=>{t=JSON.parse(t.download_ids),Object.values(t).forEach((t=>{n+=t.downloads,a[t.id]=void 0===a[t.id]?{downloads:t.downloads,title:t.title,id:t.id}:{downloads:a[t.id].downloads+t.downloads,title:t.title,id:t.id}}))})),this.mostDownloaded=Object.values(a).sort(((t,e)=>t.downloads-e.downloads)).reverse(),this.setTotalDownloads(n),this.setDailyAverage(parseInt(n/parseInt(this.stats.daysLength))),this.setMostDownloaded(this.mostDownloaded[0].title),this.setTopDownloads()}createDatepicker(){const t=new Date;let e=t.getDate()-1,a=t.getMonth()+1,n=a-1;const o=t.getFullYear();e<10&&(e="0"+e),a<10&&(a="0"+a),n<10&&(n="0"+n);const s=o+"-"+a+"-"+e,r=o+"-"+n+"-"+e;var d=jQuery("<div>").addClass("dlm_rdrs_overlay"),i=jQuery("<div>").attr("id","dlm_date_range_picker");return this.startDateInput=jQuery("<input>").attr("type","hidden").attr("id","dlm_start_date").attr("value",r),this.endDateInput=jQuery("<input>").attr("type","hidden").attr("id","dlm_end_date").attr("value",s),d.append(i).append(this.startDateInput).append(this.endDateInput),d}displayDatepicker(){if(this.datePicker.opened)return;this.datePicker.opened=!0;let t=this.createDatepicker();const e=new Date(dlmReportsStats[0].date),a=new Date;jQuery(this.datePickerContainer).append(t);var n={separator:" to ",autoClose:!0,setValue:function(e,a,n){t.find("#dlm_start_date").val(a),t.find("#dlm_end_date").val(n)},inline:!0,alwaysOpen:!0,container:"#dlm_date_range_picker",endDate:new Date,startDate:e,showShortcuts:!0,shortcuts:null,customShortcuts:[{name:"Last 7 Days",dates:function(){return[new Date(a.getFullYear(),a.getMonth(),a.getDate()-7),a]}},{name:"Last 30 Days",dates:function(){return[new Date(a.getFullYear(),a.getMonth(),a.getDate()-30),a]}},{name:"This month",dates:function(){return[new Date(a.getFullYear(),a.getMonth(),1),a]}},{name:"Last month",dates:function(){let t=moment().month(a.getMonth()-1).startOf("month")._d,n=moment().month(a.getMonth()-1).endOf("month")._d;return 0===a.getMonth()&&(t=moment().year(a.getFullYear()-1).month(11).startOf("month")._d,n=moment().year(a.getFullYear()-1).month(11).endOf("month")._d),t.getTime()<e.getTime()&&n.getTime()>e.getTime()?[e,n]:[t,n]}},{name:"This Year",dates:function(){const t=moment().startOf("year")._d;return t.getTime()<e.getTime()?[e,a]:[t,a]}},{name:"Last Year",dates:function(){return[moment().year(a.getFullYear()-1).month(0).startOf("month")._d,moment().year(a.getFullYear()-1).month(11).endOf("month")._d]}},{name:"All time",dates:function(){return[e,a]}}]};t.dateRangePicker(n).on("datepicker-change",((e,a)=>{if(a.date1&&a.date2){const e=a.date1.toLocaleDateString(void 0,{year:"numeric",month:"short",day:"2-digit"}),n=a.date2.toLocaleDateString(void 0,{year:"numeric",month:"short",day:"2-digit"});t.parent().find("span.date-range-info").text(e+" to "+n)}this.createDataOnDate(a.date1,a.date2),this.dlmCreateChart(this.stats.chartStats,this.chartContainer),this.dlmDownloadsSummary(a.date1,a.date2),t.data("dateRangePicker").close()}))}hideDatepicker(){this.datePicker.opened=!1,jQuery(this.datePickerContainer).find("#dlm_date_range_picker").remove()}toggleDatepicker(t){t.stopPropagation(),this.datePicker.opened?this.hideDatepicker():this.displayDatepicker()}setTotalDownloads(t){jQuery(".dlm-reports-block-summary li#total span").html(t)}setDailyAverage(t){jQuery(".dlm-reports-block-summary li#average span").html(t)}setMostDownloaded(t){jQuery(".dlm-reports-block-summary li#popular span").html(t)}setTodayDownloads(){if(0<=Object.keys(dlmReportsStats))return void jQuery(".dlm-reports-block-summary li#today span").html("0");const t=dlmReportsStats[dlmReportsStats.length-1];let e=0;this.createDateElement(new Date(t.date))===this.createDateElement(new Date)&&Object.values(JSON.parse(t.download_ids)).map((t=>(e+=t.downloads,e))),jQuery(".dlm-reports-block-summary li#today span").html(e)}setTopDownloads(t=0,e=!1){const a=jQuery("#total_downloads_table");if(a.empty(),!this.mostDownloaded||!0===e)return;var n=jQuery(document.createElement("table"));n.attr("cellspacing",0).attr("cellpadding",0).attr("border",0);var o=document.createElement("tr");const s=document.createElement("th");s.innerHTML="#number",o.appendChild(s);const r=document.createElement("th");r.innerHTML="ID",o.appendChild(r);const d=document.createElement("th");d.innerHTML="Title",o.appendChild(d);const i=document.createElement("th");i.innerHTML="Downloads",o.appendChild(i),n.append(o);const l=JSON.parse(JSON.stringify(this.mostDownloaded)).slice(15*parseInt(t),15*parseInt(t+1));for(let e=0;e<l.length;e++){var h=document.createElement("tr");for(let a=0;a<4;a++){let n=document.createElement("td");n.innerHTML=0===a?parseInt(15*t)+e+1:1===a?l[e].id:2===a?'<a href="'+dlm_admin_url+"post.php?post="+l[e].id+'&action=edit" target="_blank">'+l[e].title+"</a>":l[e].downloads,h.appendChild(n)}n.append(h)}a.append(n),a.find(".dlm-reports-placeholder-no-data").remove(),this.mostDownloaded.length>15?a.parent().find("#downloads-block-navigation button").removeClass("hidden"):a.parent().find("#downloads-block-navigation button").addClass("hidden")}handleTopDownloads(){const t=this;jQuery("#downloads-block-navigation").on("click","button",(function(){let e=jQuery(this).parents("#total_downloads_table_wrapper"),a=e.find("#total_downloads_table").attr("data-page"),n=e.find("#total_downloads_table table"),o=jQuery(this),s=parseInt(a)+1,r=0!==a?parseInt(a)-1:0;e.find("#total_downloads_table").css("height",n.height()+30),o.attr("disabled","disabled"),"load-more"===o.data("action")?(e.find("#total_downloads_table").attr("data-page",s),t.setTopDownloads(s),jQuery("#downloads-block-navigation").find("button").removeAttr("disabled")):0!==parseInt(a)&&(e.find("#total_downloads_table").attr("data-page",r),t.setTopDownloads(r),1!==parseInt(a)&&jQuery("#downloads-block-navigation").find("button").removeAttr("disabled"))}))}tabNagivation(){jQuery(document).on("click",".dlm-reports .dlm-insights-tab-navigation > li",(function(){const t=jQuery(this),e=jQuery(".dlm-reports .dlm-insights-tab-navigation > li").not(t),a=jQuery('div.dlm-insights-tab-navigation__content[data-id="'+t.attr("id")+'"]'),n=jQuery("div.dlm-insights-tab-navigation__content").not(a);t.hasClass("active")||(t.addClass("active"),e.removeClass("active"),a.addClass("active"),n.removeClass("active"))}))}init(){const t=this;t.dlmCreateChart(this.stats.chartStats,this.chartContainer),t.dlmDownloadsSummary(!1,!1),t.datePickerContainer.addEventListener("click",t.toggleDatepicker.bind(this)),t.setTodayDownloads(),t.handleTopDownloads(),t.tabNagivation(),jQuery(document).on("click","body",(function(e){e.stopPropagation(),jQuery(t.datePickerContainer).find("#dlm_date_range_picker").length>0&&t.hideDatepicker()}))}async fetchData(){const t=await fetch("http://localhost/dm/wp-json/download-monitor/v1/reports");this.reportsData=await t.json()}}