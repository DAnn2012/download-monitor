jQuery(function(t){new DLM_Reports});class DLM_Reports{constructor(){this.chartContainer=document.getElementById("total_downloads_chart");const t=this.chartContainer.getContext("2d");this.chartColors={purple:{default:"rgba(149, 76, 233, 1)",half:"rgba(149, 76, 233, 0.75)",quarter:"rgba(149, 76, 233, 0.5)",zero:"rgba(149, 76, 233, 0.05)"},indigo:{default:"rgba(80, 102, 120, 1)",quarter:"rgba(80, 102, 120, 0.5)"}},this.chartGradient=t.createLinearGradient(0,25,0,300),this.chartGradient.addColorStop(0,this.chartColors.purple.half),this.chartGradient.addColorStop(.45,this.chartColors.purple.quarter),this.chartGradient.addColorStop(1,this.chartColors.purple.zero),this.datePickerContainer=document.getElementById("dlm-date-range-picker"),this.reportsData="undefined"!=typeof dlmReportsStats?JSON.parse(JSON.stringify(dlmReportsStats)):{},this.mostDownloaded=!1,this.stats=!1,this.createDataOnDate(!1,!1),this.datePicker={opened:!1},this.init()}getDates(t,e){const a=[];let n=t;for(;n<=e;)a[this.createDateElement(n)]=0,n=this.getNextDay(n);return a}getNextDay(t){const e=new Date(t);return e.setDate(t.getDate()+1),e}createDateElement(t){return t.getFullYear()+"-"+(t.getMonth()+1)+"-"+t.getDate()}createDataOnDate(t,e){let a,n;if(this.reportsData="undefined"!=typeof dlmReportsStats?JSON.parse(JSON.stringify(dlmReportsStats)):{},void 0!==t&&t)a=this.createDateElement(new Date(t));else{const r=new Date;r.setDate(r.getDate()-30),a=this.createDateElement(r)}if(void 0!==e&&e)n=this.createDateElement(new Date(e));else{const d=new Date;d.setDate(d.getDate()+1),n=this.createDateElement(d)}let o=this.getDates(new Date(a),new Date(n));Object.values(this.reportsData).forEach((t,e)=>{var a=JSON.parse(t.download_ids),t=new Date(t.date);const n=this.createDateElement(t);void 0!==o[n]?Object.values(a).forEach((t,e)=>{o[n]=o[n]+t.downloads}):delete this.reportsData[e]});t=Object.keys(o).length,e=Object.keys(o).findIndex(t=>{t=new Date(t),t=this.createDateElement(t);return a===t});let s=Object.keys(o).findIndex(t=>{t=new Date(t),t=this.createDateElement(t);return n===t});-1!==e||-1!==s?(-1===s&&(s=t),this.stats={chartStats:Object.assign({},o),summaryStats:this.reportsData,daysLength:t}):this.stats={chartStats:Object.assign({},o),summaryStats:!1,daysLength:t}}dlmCreateChart(t,e){if(t&&e){const a=Chart.getChart("total_downloads_chart");void 0!==a&&a.destroy();t=[{label:"Downloads",color:"#27ae60",data:t,type:"line",fill:!0,backgroundColor:this.chartGradient,pointBackgroundColor:this.chartColors.purple.default,borderColor:this.chartColors.purple.default,lineTension:.2,borderWidth:2,pointRadius:3,elements:{line:{borderColor:"#2ecc71",borderWidth:2}}}];this.chart=new Chart(e,{title:"",data:{datasets:t},height:450,show_dots:0,x_axis_mode:"tick",y_axis_mode:"span",is_series:1,options:{aspectRatio:3,animation:!1,scales:{x:{grid:{display:!1}}},normalized:!0,parsing:{xAxisKey:"x",yAxisKey:"y"}}})}}dlmDownloadsSummary(){let a={},n=0;if(!1===this.stats||!1===this.stats.summaryStats||Object.keys(this.stats.summaryStats).length<=0)return this.setTotalDownloads(0),this.setDailyAverage(0),this.setMostDownloaded("--"),void this.setTopDownloads(0,!0);this.stats.summaryStats.forEach(t=>{t=JSON.parse(t.download_ids),Object.entries(t).forEach(([t,e])=>{n+=e.downloads,a[t]=void 0===a[t]?{downloads:e.downloads,title:e.title,id:t}:{downloads:a[t].downloads+e.downloads,title:e.title,id:t}})}),this.mostDownloaded=Object.values(a).sort((t,e)=>t.downloads-e.downloads).reverse(),this.setTotalDownloads(n),this.setDailyAverage((n/parseInt(this.stats.daysLength)).toFixed(2)),this.setMostDownloaded(this.mostDownloaded[0].title),this.setTopDownloads()}createDatepicker(){const t=new Date;let e=t.getDate()-1,a=t.getMonth()+1,n=a-1;var o=t.getFullYear();e<10&&(e="0"+e),a<10&&(a="0"+a),n<10&&(n="0"+n);var s=o+"-"+a+"-"+e,r=o+"-"+n+"-"+e,d=jQuery("<div>").addClass("dlm_rdrs_overlay"),o=jQuery("<div>").attr("id","dlm_date_range_picker");return this.startDateInput=jQuery("<input>").attr("type","hidden").attr("id","dlm_start_date").attr("value",r),this.endDateInput=jQuery("<input>").attr("type","hidden").attr("id","dlm_end_date").attr("value",s),d.append(o).append(this.startDateInput).append(this.endDateInput),d}displayDatepicker(){if(!this.datePicker.opened){this.datePicker.opened=!0;let o=this.createDatepicker();const s=0<Object.keys(dlmReportsStats).length?new Date(dlmReportsStats[0].date):new Date,r=new Date;jQuery(this.datePickerContainer).append(o);const d=[];if(s.getTime()!==r.getTime()){let t=new Date,a=moment().month(r.getMonth()-1).startOf("month")._d,e=new Date(r.getFullYear(),r.getMonth(),1),n=moment().startOf("year")._d,o=moment().year(r.getFullYear()-1).month(0).startOf("month")._d;t=t.setDate(t.getDate()-6),s.getTime()<t&&d.push({name:"Last 7 Days",dates:function(){return[new Date(r.getFullYear(),r.getMonth(),r.getDate()-7),new Date(r.getDate()+1)]}}),s.getTime()<e&&d.push({name:"This month",dates:function(){return[new Date(r.getFullYear(),r.getMonth(),1),r]}}),s.getTime()<a.getTime()&&d.push({name:"Last month",dates:function(){let t=a,e=moment().month(r.getMonth()-1).endOf("month")._d;return 0===r.getMonth()&&(t=moment().year(r.getFullYear()-1).month(11).startOf("month")._d,e=moment().year(r.getFullYear()-1).month(11).endOf("month")._d),[t,e]}}),s.getTime()<n.getTime()&&d.push({name:"This Year",dates:function(){const t=moment().startOf("year")._d;return t.getTime()<s.getTime()?[s,r]:[t,r]}}),s.getTime()<o.getTime()&&d.push({name:"Last Year",dates:function(){return[moment().year(r.getFullYear()-1).month(0).startOf("month")._d,moment().year(r.getFullYear()-1).month(11).endOf("month")._d]}})}d.push({name:"All time",dates:function(){return[s,r]}});var t={separator:" to ",autoClose:!0,setValue:function(t,e,a){o.find("#dlm_start_date").val(e),o.find("#dlm_end_date").val(a)},inline:!0,alwaysOpen:!0,container:"#dlm_date_range_picker",endDate:new Date,startDate:s,showShortcuts:!0,shortcuts:null,customShortcuts:d};o.dateRangePicker(t).on("datepicker-change",(t,e)=>{var a,n;e.date1&&e.date2&&(a=e.date1.toLocaleDateString(void 0,{year:"numeric",month:"short",day:"2-digit"}),n=e.date2.toLocaleDateString(void 0,{year:"numeric",month:"short",day:"2-digit"}),o.parent().find("span.date-range-info").text(a+" to "+n)),this.createDataOnDate(e.date1,e.date2),this.dlmCreateChart(this.stats.chartStats,this.chartContainer),this.dlmDownloadsSummary(),o.data("dateRangePicker").close()})}}hideDatepicker(){this.datePicker.opened=!1,jQuery(this.datePickerContainer).find("#dlm_date_range_picker").remove()}toggleDatepicker(t){t.stopPropagation(),this.datePicker.opened?this.hideDatepicker():this.displayDatepicker()}setTotalDownloads(t){jQuery(".dlm-reports-block-summary li#total span").html(t)}setDailyAverage(t){jQuery(".dlm-reports-block-summary li#average span").html(t)}setMostDownloaded(t){jQuery(".dlm-reports-block-summary li#popular span").html(t)}setTodayDownloads(){let t=0;var e;Object.keys(dlmReportsStats).length<=0||(e=dlmReportsStats[dlmReportsStats.length-1],this.createDateElement(new Date(e.date))===this.createDateElement(new Date)&&(t=Object.values(JSON.parse(e.download_ids)).reduce((t,e)=>t.downloads+e.downloads))),jQuery(".dlm-reports-block-summary li#today span").html(t)}setTopDownloads(n=0,t=!1){const e=jQuery("#total_downloads_table");if(e.empty(),this.mostDownloaded&&!0!==t){var o=jQuery(document.createElement("table"));o.attr("cellspacing",0).attr("cellpadding",0).attr("border",0);t=document.createElement("tr");const a=document.createElement("th");a.innerHTML="#number",t.appendChild(a);const d=document.createElement("th");d.innerHTML="ID",t.appendChild(d);const i=document.createElement("th");i.innerHTML="Title",t.appendChild(i);const l=document.createElement("th");l.innerHTML="Downloads",t.appendChild(l),o.append(t);var s=JSON.parse(JSON.stringify(this.mostDownloaded)).slice(15*parseInt(n),15*parseInt(n+1));for(let a=0;a<s.length;a++){var r=document.createElement("tr");for(let e=0;e<4;e++){let t=document.createElement("td");0===e?t.innerHTML=parseInt(15*n)+a+1:1===e?t.innerHTML=s[a].id:2===e?t.innerHTML='<a href="'+dlm_admin_url+"post.php?post="+s[a].id+'&action=edit" target="_blank">'+s[a].title+"</a>":t.innerHTML=s[a].downloads,r.appendChild(t)}o.append(r)}e.append(o),e.find(".dlm-reports-placeholder-no-data").remove(),15<this.mostDownloaded.length?e.parent().find("#downloads-block-navigation button").removeClass("hidden"):e.parent().find("#downloads-block-navigation button").addClass("hidden")}}handleTopDownloads(){const r=this;jQuery("#downloads-block-navigation").on("click","button",function(){let t=jQuery(this).parents("#total_downloads_table_wrapper"),e=t.find("#total_downloads_table").attr("data-page"),a=t.find("#total_downloads_table table"),n=jQuery(this),o=parseInt(e)+1,s=0!==e?parseInt(e)-1:0;t.find("#total_downloads_table").css("height",a.height()+30),n.attr("disabled","disabled"),"load-more"===n.data("action")?(t.find("#total_downloads_table").attr("data-page",o),r.setTopDownloads(o),jQuery("#downloads-block-navigation").find("button").removeAttr("disabled")):0!==parseInt(e)&&(t.find("#total_downloads_table").attr("data-page",s),r.setTopDownloads(s),1!==parseInt(e)&&jQuery("#downloads-block-navigation").find("button").removeAttr("disabled"))})}tabNagivation(){jQuery(document).on("click",".dlm-reports .dlm-insights-tab-navigation > li",function(){const t=jQuery(this),e=jQuery(".dlm-reports .dlm-insights-tab-navigation > li").not(t),a=jQuery('div.dlm-insights-tab-navigation__content[data-id="'+t.attr("id")+'"]'),n=jQuery("div.dlm-insights-tab-navigation__content").not(a);t.hasClass("active")||(t.addClass("active"),e.removeClass("active"),a.addClass("active"),n.removeClass("active"))})}init(){const e=this;e.dlmCreateChart(this.stats.chartStats,this.chartContainer),e.dlmDownloadsSummary(),e.datePickerContainer.addEventListener("click",e.toggleDatepicker.bind(this)),e.setTodayDownloads(),e.handleTopDownloads(),e.tabNagivation(),jQuery(document).on("click","body",function(t){t.stopPropagation(),0<jQuery(e.datePickerContainer).find("#dlm_date_range_picker").length&&e.hideDatepicker()})}async fetchData(){const t=await fetch(dlmReportsAPI);this.reportsData=await t.json()}}