jQuery(function(t){const e=new DLM_Reports;dlmReportsInstance.fetchReportsData(),t(document).on("dlm_downloads_report_fetched",function(){e.init()})});class DLM_Reports{dlmReportsStats=[];dlmUsersStats={logs:[],users:[]};currentFilters=[];tempDownloads=null;templates={};totalDownloads=0;constructor(){(dlmReportsInstance=this).chartContainer=document.getElementById("total_downloads_chart");const t=dlmReportsInstance.chartContainer.getContext("2d");dlmReportsInstance.chartColors={purple:{default:"rgba(149, 76, 233, 1)",threesome:"rgba(149, 76, 233, 0.75)",half:"rgba(149, 76, 233, 0.5)",quarter:"rgba(149, 76, 233, 0.5)",zero:"rgba(149, 76, 233, 0.05)"},blue:{default:"rgba(67, 56, 202, 1)",threesome:"rgba(67, 56, 202, 0.75)",half:"rgba(67, 56, 202, 0.5)",quarter:"rgba(67, 56, 202, 0.25)",zero:"rgba(67, 56, 202, 0.05)"},green:{default:"rgba(00, 255, 00, 1)",threesome:"rgba(00, 255, 00, 0.75)",half:"rgba(00, 255, 00, 0.5)",quarter:"rgba(00, 255, 00, 0.25)",zero:"rgba(67, 56, 202, 0.05)"},royalBlue:{default:"rgba(65, 105, 225, 1)",threesome:"rgba(65, 105, 225, 0.75)",half:"rgba(65, 105, 225, 0.5)",quarter:"rgba(65, 105, 225, 0.25)",zero:"rgba(65, 105, 225, 0.05)"},persianBlue:{default:"rgba(28, 57, 187, 1)",threesome:"rgba(28, 57, 187, 0.75)",half:"rgba(28, 57, 187, 0.5)",quarter:"rgba(28, 57, 187, 0.25)",zero:"rgba(28, 57, 187, 0.05)"},darkCyan:{default:"rgba(0,129,167, 1)",threesome:"rgba(0,129,167, 0.75)",half:"rgba(0,129,167, 0.5)",quarter:"rgba(0,129,167, 0.25)",zero:"rgba(0,129,167, 0.05)"},strongCyan:{default:"rgba(0, 175, 185, 1)",threesome:"rgba(0, 175, 185, 0.75)",half:"rgba(0, 175, 185, 0.5)",quarter:"rgba(0, 175, 185, 0.25)",zero:"rgba(0, 175, 185, 0.05)"}},dlmReportsInstance.chartGradient=t.createLinearGradient(0,25,0,300),dlmReportsInstance.chartGradient.addColorStop(0,dlmReportsInstance.chartColors.darkCyan.half),dlmReportsInstance.chartGradient.addColorStop(.45,dlmReportsInstance.chartColors.darkCyan.quarter),dlmReportsInstance.chartGradient.addColorStop(1,dlmReportsInstance.chartColors.darkCyan.zero),dlmReportsInstance.datePickerContainer=document.getElementById("dlm-date-range-picker"),dlmReportsInstance.dataSets=[];let e=new Date;dlmReportsInstance.dates={downloads:{start_date:new Date(e.setMonth(e.getMonth()-1)),end_date:new Date}},dlmReportsInstance.chartDataObject={}}async fetchReportsData(){const t=jQuery('div[data-id="general_info"]'),e=await fetch(dlmDownloadReportsAPI);if(!e.ok){const a=document.createElement("div"),n=(a.className="dlm-loading-data",document.createTextNode("Seems like we bumped into an error! ")),s=document.createTextNode("Data fetching returned a status text of : "+fetchedData.statusText),o=document.createElement("h1"),r=document.createElement("h3");throw o.appendChild(n),r.appendChild(s),a.appendChild(o),a.appendChild(r),t.find(".dlm-loading-data").remove(),t.append(a),new Error("Something went wrong! Reports response did not come OK - "+fetchedData.statusText)}dlmReportsInstance.dlmReportsStats=await e.json(),dlmReportsInstance.mostDownloaded=!1,dlmReportsInstance.stats=!1,dlmReportsInstance.chartType="day",0<window.location.href.indexOf("dlm_time")&&(dlmReportsInstance.dates.downloads.start_date=0<Object.keys(dlmReportsInstance.dlmReportsStats).length?new Date(dlmReportsInstance.dlmReportsStats[0].date):new Date,dlmReportsInstance.dates.downloads.end_date=new Date,jQuery("#dlm-date-range-picker .date-range-info").html(dlmReportsInstance.dates.downloads.start_date.toLocaleDateString(void 0,{year:"numeric",month:"short",day:"2-digit"})+" - "+dlmReportsInstance.dates.downloads.end_date.toLocaleDateString(void 0,{year:"numeric",month:"short",day:"2-digit"}))),dlmReportsInstance.createDataOnDate(dlmReportsInstance.dates.downloads.start_date,dlmReportsInstance.dates.downloads.end_date),dlmReportsInstance.datePicker={opened:!1},jQuery(document).trigger("dlm_downloads_report_fetched",[dlmReportsInstance,dlmReportsInstance.dlmReportsStats])}async fetchUsersReportsData(t=0,e=dlmPHPinfo.retrieved_rows){const a=jQuery('div[data-id="user_reports"]');let n=dlmUserReportsAPI+"?offset="+t+"&limit="+e;0<dlmUserReportsAPI.indexOf("index.php?")&&(n=dlmUserReportsAPI+"&offset="+t+"&limit="+e);const s=await fetch(n);if(!s.ok)throw new Error("Something went wrong! Reports response did not come OK - "+s.statusText);t=await s.json();dlmReportsInstance.dlmUsersStats.logs=dlmReportsInstance.dlmUsersStats.logs.concat(t.logs),!0===t.done?(dlmReportsInstance.userDownloads=void 0!==dlmReportsInstance.dlmUsersStats.logs?JSON.parse(JSON.stringify(dlmReportsInstance.dlmUsersStats.logs)):{},a.find(".dlm-loading-data").remove(),dlmReportsInstance.userReportsTab(),dlmReportsInstance.setTopDownloads(),dlmReportsInstance.stopSpinner(jQuery("#total_downloads_table_wrapper2"))):dlmReportsInstance.fetchUsersReportsData(t.offset)}async fetchUserData(){const t=await fetch(dlmUserDataAPI);if(!t.ok)throw new Error("Something went wrong! Reports response did not come OK - "+t.statusText);var e=await t.json();dlmReportsInstance.dlmUsersStats.users=dlmReportsInstance.dlmUsersStats.users.concat(e)}init(){dlmReportsInstance.tabNagivation(),dlmReportsInstance.overViewTab(),dlmReportsInstance.togglePageSettings(),dlmReportsInstance.fetchUserData(),dlmReportsInstance.setSpinner(jQuery("#users_download_log")),dlmReportsInstance.setSpinner(jQuery("#total_downloads_table_wrapper2")),dlmReportsInstance.fetchUsersReportsData(),jQuery(document).trigger("dlm_reports_init",[dlmReportsInstance])}overViewTab(){dlmReportsInstance.dlmCreateChart(dlmReportsInstance.stats.chartStats,dlmReportsInstance.chartContainer),dlmReportsInstance.dlmDownloadsSummary(),dlmReportsInstance.datePickerContainer.addEventListener("click",dlmReportsInstance.toggleDatepicker.bind(this)),dlmReportsInstance.setTodayDownloads(),dlmReportsInstance.handleTopDownloads(),jQuery(document).on("click","body",function(t){t.stopPropagation(),0<jQuery(dlmReportsInstance.datePickerContainer).find("#dlm_date_range_picker").length&&dlmReportsInstance.hideDatepicker(jQuery(dlmReportsInstance.datePickerContainer),{target:"dlm-date-range-picker"})})}userReportsTab(){0!==Object.values(dlmReportsInstance.dlmUsersStats).length&&(dlmReportsInstance.logsDataByDate(dlmReportsInstance.dates.downloads.start_date,dlmReportsInstance.dates.downloads.end_date),dlmReportsInstance.handleUserDownloads())}getDates(t,e){const a={};let n=t;for(;n<=e;)a[this.createDateElement(n)]=0,n=this.getNextDay(n);return a}getMonths(t){const e={};return Object.keys(t).map(t=>{t=t.substring(0,7);void 0===e[t]&&(e[t]=0)}),e}getDoubleMonths(t){const e={},a=Object.keys(t)[0],n=Object.keys(t)[Object.keys(t).length-1];let s=0,o=a.substring(0,7),r=n.substring(0,7);return Object.keys(t).map(t=>{t=t.substring(0,7);o!==t&&r!==t&&(o=t,s++),void 0===e[t]&&0==s%2&&(e[t]=0)}),e}getWeeks(t){let a={};return Object.keys(t).forEach(t=>{let e;e=15<moment(t).date()?t.substring(0,7)+"-15":t.substring(0,7)+"-01",void 0===a[e]&&(a[e]=0)}),a}getWeek(t){let e={},a=Object.keys(t)[Object.keys(t).length-1],n=0;return Object.keys(t).map(t=>{void 0===e[t]&&0==n%7&&(e[t]=0),n++}),void 0===e[a]&&(e[a]=0),e}getDoubleDays(t){let e={},a=Object.keys(t)[0],n=Object.keys(t)[Object.keys(t).length-1],s=0;return Object.keys(t).map(t=>{a!==t&&n!==t&&(a=t,s++),void 0===e[t]&&0==s%2&&(e[t]=0)}),e}getNextDay(t){const e=new Date(t);return e.setDate(t.getDate()+1),e}createDateElement(t){var e=(t.getMonth()+1<10?"0":"")+(t.getMonth()+1);return t.getFullYear()+"-"+e+"-"+("0"+t.getDate()).slice(-2)}getSetDates(t,e){let a,n;if(void 0!==t&&t)a=dlmReportsInstance.createDateElement(new Date(t));else{const s=new Date;s.setDate(s.getDate()-30),a=dlmReportsInstance.createDateElement(s)}if(void 0!==e&&e){t=new Date(e);n=dlmReportsInstance.createDateElement(t)}else{const o=new Date;o.setDate(o.getDate()+1),n=dlmReportsInstance.createDateElement(o)}return{startDate:a,endDate:n}}createDataOnDate(t,e){let{startDate:a,endDate:n}={...dlmReportsInstance.getSetDates(t,e)},s,o,r,d,l,c=(dlmReportsInstance.reportsData=void 0!==dlmReportsInstance.dlmReportsStats?JSON.parse(JSON.stringify(dlmReportsInstance.dlmReportsStats)):{},o=moment(n,"YYYY-MM-DD").month()-moment(a,"YYYY-MM-DD").month(),r=moment(n,"YYYY-MM-DD").year()-moment(a,"YYYY-MM-DD").year(),s=moment(n).date()-moment(a).date(),dlmReportsInstance.chartType="day",0==r&&-6<o&&o<6?1<o||o<-1?dlmReportsInstance.chartType=2==o?"week":"weeks":1==o&&(8<s||-14<s||0==s)&&(dlmReportsInstance.chartType="days"):o<=0?dlmReportsInstance.chartType="month":dlmReportsInstance.chartType="months",dlmReportsInstance.getDates(new Date(a),new Date(n))),m,i,p,g;switch(dlmReportsInstance.chartType){case"months":i=dlmReportsInstance.getDoubleMonths(c),l=i;break;case"month":var u=dlmReportsInstance.getMonths(c);l=u;break;case"weeks":p=dlmReportsInstance.getWeeks(c),l=p;break;case"week":g=dlmReportsInstance.getWeek(c),l=g;break;case"days":m=dlmReportsInstance.getDoubleDays(c),l=m;break;case"day":l=c}Object.values(dlmReportsInstance.reportsData).forEach((s,t)=>{var o=JSON.parse(s.download_ids);if(void 0!==c[s.date])switch(dlmReportsInstance.chartType){case"months":d=s.date.substring(0,7);let t=parseInt(s.date.substring(5,7)),e=s.date.substring(0,5),a=6<(t-1).length?e+(t-1):e+"0"+(t-1);Object.values(o).forEach((t,e)=>{void 0===i[d]?void 0!==i[a]&&(i[a]=i[a]+t.downloads):i[d]=i[d]+t.downloads}),l=i;break;case"month":d=s.date.substring(0,7),Object.values(o).forEach((t,e)=>{monthDownloads[d]=void 0!==monthDownloads[d]?monthDownloads[d]+t.downloads:t.downloads}),l=monthDownloads;break;case"weeks":d=15<moment(s.date).date()?s.date.substring(0,7)+"-15":s.date.substring(0,7)+"-01",Object.values(o).forEach((t,e)=>{p[d]=void 0!==p[d]?p[d]+t.downloads:t.downloads}),l=p;break;case"week":d=s.date,Object.values(o).forEach((e,t)=>{if(void 0===g[d])for(let t=1;t<8;t++){var a=moment(s.date).date(moment(s.date).date()-t).format("YYYY-MM-DD");void 0!==g[a]&&(g[a]=g[a]+e.downloads)}else g[d]=g[d]+e.downloads}),l=g;break;case"days":d=s.date;let n=moment(s.date).date(moment(s.date).date()-1).format("YYYY-MM-DD");Object.values(o).forEach((t,e)=>{void 0===m[d]?void 0!==m[n]&&(m[n]=m[n]+t.downloads):m[d]=m[d]+t.downloads}),l=m;break;case"day":Object.values(o).forEach((t,e)=>{c[s.date]=c[s.date]+t.downloads}),l=c}else delete dlmReportsInstance.reportsData[t]});const h=Object.keys(c);t=h.length,e=h.findIndex(t=>a===t);let R=h.findIndex(t=>n===t);-1===e&&-1===R?dlmReportsInstance.stats={chartStats:Object.assign({},l),summaryStats:!1,daysLength:t}:(-1===R&&(R=t),dlmReportsInstance.stats={chartStats:Object.assign({},l),summaryStats:dlmReportsInstance.reportsData,daysLength:t})}dlmCreateChart(e,a,n=!1){if(e&&a){let t=Chart.getChart("total_downloads_chart");dlmReportsInstance.chartDataObject={dataSetLabel:"Downloads",dataSetColor:"#27ae60",dataSetbg:dlmReportsInstance.chartGradient,dataSetPointbg:dlmReportsInstance.chartColors.darkCyan.default,dataSetBorder:dlmReportsInstance.chartColors.darkCyan.default,dataSetElementColor:"#2ecc71",lineType:"original",xAxis:"x",chartData:e},void 0!==t&&t.destroy(),jQuery(document).trigger("dlm_reports_before_data_sets",[dlmReportsInstance.chartDataObject,e,n]),0<dlmReportsInstance.dataSets.length&&(dlmReportsInstance.dataSets=dlmReportsInstance.dataSets.filter(t=>dlmReportsInstance.chartDataObject.lineType!==t.origin)),dlmReportsInstance.dataSets.push({origin:dlmReportsInstance.chartDataObject.lineType,label:dlmReportsInstance.chartDataObject.dataSetLabel,color:dlmReportsInstance.chartDataObject.dataSetColor,data:dlmReportsInstance.chartDataObject.chartData,type:"line",fill:!0,backgroundColor:dlmReportsInstance.chartDataObject.dataSetbg,pointBackgroundColor:dlmReportsInstance.chartDataObject.dataSetPointbg,pointHoverBackgroundColor:"#fff",borderColor:dlmReportsInstance.chartDataObject.dataSetBorder,pointBorderWidth:1,lineTension:.3,borderWidth:1,pointRadius:3,elements:{line:{borderColor:dlmReportsInstance.chartDataObject.dataSetElementColor,borderWidth:1},point:{radius:4,hoverRadius:4,pointStyle:"circle"}}});e=Object.values(dlmReportsInstance.dataSets).filter(t=>"original"===t.origin);let o=Object.keys(e[0].data);dlmReportsInstance.dataSets.sort(function(t,e){return"original"===t.origin?-1:1}),dlmReportsInstance.chart=new Chart(a,{title:"",data:{datasets:dlmReportsInstance.dataSets},height:450,is_series:1,options:{aspectRatio:5,animation:!1,interaction:{mode:"index",intersect:!1},stacked:!1,scales:{x:{grid:{display:!1},ticks:{callback:t=>{let e="";var a=o[t],n=o[o.length-1],s=moment(n).month(moment(n).month()-1).format("YYYY-MM");return e="undefined"!==dlmReportsInstance.chartType&&"months"===dlmReportsInstance.chartType?(t=moment(o[t]).month())<11?a===s?moment(a).format("MMM, YYYY"):moment(a).format("MMM")+" - "+moment(a).month(t+1).format("MMM")+moment(a).format(", YYYY"):a===s||a===n?moment(a).format("MMM, YYYY"):moment(a).format("MMM")+moment(a).format(" YYYY")+" - "+moment(a).month(t+1).format("MMM")+moment(a).month(t+1).format(", YYYY"):"undefined"!==dlmReportsInstance.chartType&&"months"===dlmReportsInstance.chartType?moment(a).format("MMMM, YYYY"):moment(a).format("D MMM")}}},y:{grid:{drawBorder:!1},min:0,max:0!==dlmReportsInstance.getMaxDownload()?1===Math.ceil(dlmReportsInstance.getMaxDownload()/10)?dlmReportsInstance.getMaxDownload()+1:10*Math.ceil(dlmReportsInstance.getMaxDownload()/10):100,ticks:{stepSize:0!==dlmReportsInstance.getMaxDownload()?Math.ceil(dlmReportsInstance.getMaxDownload()/4):25,callback:t=>dlmReportsInstance.shortNumber(t)}}},normalized:!0,parsing:{xAxisKey:"x",yAxisKey:"y"},plugins:{tooltip:{enabled:!1,external:dlmReportsInstance.externalTooltipHandler.bind(dlmReportsInstance,this)},legend:{display:!0}}}})}}dlmDownloadsSummary(){let a={};if(!1===dlmReportsInstance.stats||!1===dlmReportsInstance.stats.summaryStats||Object.keys(dlmReportsInstance.stats.summaryStats).length<=0)return this.setTotalDownloads(0),this.setDailyAverage(0),void this.setMostDownloaded("--");dlmReportsInstance.totalDownloads=0,dlmReportsInstance.stats.summaryStats.forEach(t=>{t=JSON.parse(t.download_ids),Object.entries(t).forEach(([t,e])=>{dlmReportsInstance.totalDownloads+=e.downloads,a[t]=void 0===a[t]?{downloads:e.downloads,title:e.title,id:t}:{downloads:a[t].downloads+e.downloads,title:e.title,id:t}})}),dlmReportsInstance.mostDownloaded=Object.values(a).sort((t,e)=>t.downloads-e.downloads).reverse(),dlmReportsInstance.setTotalDownloads(dlmReportsInstance.totalDownloads),dlmReportsInstance.setDailyAverage((dlmReportsInstance.totalDownloads/parseInt(dlmReportsInstance.stats.daysLength)).toFixed(0)),dlmReportsInstance.setMostDownloaded(dlmReportsInstance.mostDownloaded[0].title)}createDatepicker(t,e,a){const n=new Date;let s=n.getDate()-1,o=n.getMonth()+1,r=o-1;var d=n.getFullYear(),l=(s<10&&(s="0"+s),o<10&&(o="0"+o),r<10&&(r="0"+r),d+"-"+o+"-"+s),d=d+"-"+r+"-"+s,c=jQuery("<div>").addClass("dlm_rdrs_overlay"),a=jQuery("<div>").attr("id",a.replace("#",""));return"dlm-date-range-picker"===e.target?(dlmReportsInstance.startDateInput=jQuery("<input>").attr("type","hidden").attr("id","dlm_start_date").attr("value",d),dlmReportsInstance.endDateInput=jQuery("<input>").attr("type","hidden").attr("id","dlm_end_date").attr("value",l),c.append(a).append(dlmReportsInstance.startDateInput).append(dlmReportsInstance.endDateInput)):jQuery(document).trigger("dlm_create_date_picker_"+e.target,[dlmReportsInstance,c,a,d,l]),c}displayDatepicker(t,o){var e;if(jQuery(t)){if(e="#"+jQuery(t).attr("id").replace(/-/gi,"_"),"dlm-date-range-picker"===o.target){if(dlmReportsInstance.datePicker.opened)return;dlmReportsInstance.datePicker.opened=!0}else jQuery(document).trigger("dlm_display_datepicker_"+o.target,[dlmReportsInstance,o,t]);let s=dlmReportsInstance.createDatepicker(t,o,e);t.append(s);var a=0<Object.keys(dlmReportsInstance.dlmReportsStats).length?new Date(dlmReportsInstance.dlmReportsStats[0].date):new Date,n=(new Date,[]),t=(jQuery(document).trigger("dlm_datepicker_shortcuts_"+o.target,[dlmReportsInstance,o,t,n]),{separator:" to ",autoClose:!0,getValue:function(){},setValue:function(t,e,a){s.find('input[type="hidden"]').first().val(e),s.find('input[type="hidden"]').last().val(a)},inline:!0,alwaysOpen:!0,container:e,endDate:new Date,startDate:a,showShortcuts:!0,shortcuts:null,customShortcuts:n});s.dateRangePicker(t).on("datepicker-change",(t,e)=>{var a,n;e.date1&&e.date2&&(a=e.date1.toLocaleDateString(void 0,{year:"numeric",month:"short",day:"2-digit"}),n=e.date2.toLocaleDateString(void 0,{year:"numeric",month:"short",day:"2-digit"}),s.parent().find("span.date-range-info").text(a+" - "+n)),"dlm-date-range-picker"===o.target?(dlmReportsInstance.dates.downloads={start_date:e.date1,end_date:e.date2},dlmReportsInstance.createDataOnDate(dlmReportsInstance.dates.downloads.start_date,dlmReportsInstance.dates.downloads.end_date),dlmReportsInstance.dlmCreateChart(dlmReportsInstance.stats.chartStats,dlmReportsInstance.chartContainer,!1),dlmReportsInstance.dlmDownloadsSummary(),0<Object.values(dlmReportsInstance.dlmUsersStats.logs).length&&dlmReportsInstance.logsDataByDate(dlmReportsInstance.dates.downloads.start_date,dlmReportsInstance.dates.downloads.end_date)):jQuery(document).trigger("dlm_daterangepicker_init_"+o.target,[dlmReportsInstance,e.date1,e.date2]),dlmReportsInstance.setTopDownloads(),s.data("dateRangePicker").close()}),"dlm-date-range-picker"===o.target?s.data("dateRangePicker").setDateRange(dlmReportsInstance.dates.downloads.start_date,dlmReportsInstance.dates.downloads.end_date):jQuery(document).trigger("dlm_daterangepicker_after_init_"+o.target,[s,dlmReportsInstance])}}hideDatepicker(t,e){"dlm-date-range-picker"===e.target?dlmReportsInstance.datePicker.opened=!1:jQuery(document).trigger("dlm_hide_datepicker_"+e.target,[dlmReportsInstance,t,e]),t.find(".dlm_rdrs_overlay").remove()}toggleDatepicker(t){t.stopPropagation();const e=jQuery(t.target).parents(".dlm-reports-header-date-selector");t={target:e.attr("id"),object:dlmReportsInstance.datePicker};dlmReportsInstance.closeDatePickers(e),"dlm-date-range-picker"===t.target?dlmReportsInstance.datePicker.opened?dlmReportsInstance.hideDatepicker(e,t):dlmReportsInstance.displayDatepicker(e,t):jQuery(document).trigger("dlm_toggle_datepicker_"+t.target,[dlmReportsInstance,e,t])}setTotalDownloads(t){jQuery(".dlm-reports-block-summary li#total span").html(t.toLocaleString())}setDailyAverage(t){jQuery(".dlm-reports-block-summary li#average span").html(t.toLocaleString())}setMostDownloaded(t){jQuery(".dlm-reports-block-summary li#popular span").html(t)}setTodayDownloads(){let t=0;Object.keys(dlmReportsInstance.dlmReportsStats).length<=0?jQuery(".dlm-reports-block-summary li#today span").html(t.toLocaleString()):(dlmReportsInstance.dlmReportsStats[dlmReportsInstance.dlmReportsStats.length-1].date===dlmReportsInstance.createDateElement(new Date)&&(t=Object.values(JSON.parse(dlmReportsInstance.dlmReportsStats[dlmReportsInstance.dlmReportsStats.length-1].download_ids)).reduce((t,e)=>t+e.downloads,0)),jQuery(".dlm-reports-block-summary li#today span").html(t))}setTopDownloads(t=0,e=!1){const a=jQuery("#total_downloads_table_wrapper2"),n=jQuery("#total_downloads_table_wrapper2 .total_downloads_table__list");if(n.empty(),n.parent().addClass("empty"),dlmReportsInstance.mostDownloaded&&!0!==e){var s=JSON.parse(JSON.stringify(dlmReportsInstance.mostDownloaded)).slice(10*parseInt(t),10*parseInt(t+1));for(let t=0;t<s.length;t++){const r=dlmReportsInstance.getDownloadByID(s[t].id);if(void 0===r)return;var o={id:s[t].id,title:s[t].title,edit_link:dlmAdminUrl+"post.php?post="+s[t].id+"&action=edit",total_downloads:r.total.toLocaleString()};jQuery(document).trigger("dlm_reports_top_downloads_item_before_render",[o,dlmReportsInstance,s[t],r]),new dlmBackBone.modelTopDownloads(o)}n.parent().removeClass("empty"),10<dlmReportsInstance.mostDownloaded.length?a.find(".downloads-block-navigation button").removeClass("hidden"):a.find(".downloads-block-navigation button").addClass("hidden"),dlmReportsInstance.stopSpinner(jQuery("#total_downloads_table_wrapper2"))}}handleTopDownloads(){jQuery("html body").on("click","#total_downloads_table_wrapper2 .downloads-block-navigation button",function(){let t=jQuery(this).parents("#total_downloads_table_wrapper2"),e=t,a=t.attr("data-page"),n=jQuery(this),s=parseInt(a)+1,o=0!==a?parseInt(a)-1:0,r=t.find(".downloads-block-navigation").find("button").first(),d=t.find(".downloads-block-navigation").find("button").last();n.attr("disabled","disabled");var l={data:dlmReportsInstance.mostDownloaded,main_parent:t,offsetHolder:e,offset:a,link:n,nextPage:s,prevPage:o,prevButton:r,nextButton:d,doAction:dlmReportsInstance.setTopDownloads};dlmReportsInstance.handleSliderNavigation(l)})}handleSliderNavigation(t){const{data:e,offsetHolder:a,offset:n,link:s,nextPage:o,prevPage:r,prevButton:d,nextButton:l,doAction:c}={...t};"load-more"===s.data("action")?(a.attr("data-page",o),c(o),Math.ceil(e.length/10)>o+1&&l.removeAttr("disabled"),d.removeAttr("disabled")):0!==parseInt(n)&&(a.attr("data-page",r),c(r),1!==parseInt(n)&&d.removeAttr("disabled"),l.removeAttr("disabled"))}tabNagivation(){jQuery(document).on("click",".dlm-reports .dlm-insights-tab-navigation > li",function(){const t=jQuery(this),e=jQuery(".dlm-reports .dlm-insights-tab-navigation > li").not(t),a=jQuery('div.dlm-insights-tab-navigation__content[data-id="'+t.attr("id")+'"]'),n=jQuery("div.dlm-insights-tab-navigation__content").not(a);t.hasClass("active")||(t.addClass("active"),e.removeClass("active"),a.addClass("active"),n.removeClass("active"))})}getOrCreateTooltip(t){let e=t.canvas.parentNode.querySelector("div.dlm-canvas-tooltip"),a=t.canvas.parentNode.querySelector("div.dlm-reports-tooltip__line");if(e||((a=document.createElement("div")).className="dlm-reports-tooltip__line"),!e){(e=document.createElement("div")).className="dlm-canvas-tooltip";const n=document.createElement("div");n.className="dlm-reports-tooltip",e.appendChild(n),t.canvas.parentNode.appendChild(e),t.canvas.parentNode.appendChild(a)}return{tooltipEl:e,tooltipLine:a}}externalTooltipHandler(d,t){const{chart:e,tooltip:l}=t,{tooltipEl:a,tooltipLine:n}={...d.getOrCreateTooltip(e)};t=jQuery(a).parent().width();if(0===l.opacity)return a.style.opacity=0,void(n.style.opacity=0);if(l.body){const c=l.title||[],m=document.createElement("div"),i=(m.className="dlm-reports-tooltip__header",c.forEach(t=>{const e=document.createElement("div"),a=(e.className="dlm-reports-tooltip__row",document.createElement("p")),n=(a.className="dlm-reports-tooltip__info",a.appendChild(document.createTextNode("Downloads")),e.appendChild(a),jQuery(document).trigger("dlm_chart_tooltip_before",[dlmReportsInstance,l,e,d]),document.createElement("p"));n.className="dlm-reports-tooltip__date";var s=dlmReportsInstance.setChartTooltipDate(l.dataPoints[0].label,d,d.stats.chartStats);n.appendChild(document.createTextNode(s)),e.appendChild(n);const o=document.createElement("p"),r=(o.className="dlm-reports-tooltip__downloads",document.createElement("span"));r.className="dlm-reports-tooltip__downloads_pointer",r.style.backgroundColor=dlmReportsInstance.chartColors.darkCyan.default,o.appendChild(r),o.appendChild(document.createTextNode(dlmReportsInstance.shortNumber(l.dataPoints[0].formattedValue))),e.appendChild(o),jQuery(document).trigger("dlm_chart_tooltip_after",[dlmReportsInstance,l,e,d]),m.appendChild(e)}),a.querySelector("div.dlm-reports-tooltip"));for(;i.firstChild;)i.firstChild.remove();i.appendChild(m)}var{offsetLeft:s,offsetTop:o}=e.canvas;a.style.opacity=1;let r={isMargin:!(n.style.opacity=1),left:!1};l.caretX-l.width<0&&(r.isMargin=!0,r.left=!0),s+l.caretX+l.width>t&&(r.isMargin=!0,r.left=!1),r.isMargin?r.left?a.style.left=s+l.width+"px":a.style.left=t-l.width+"px":a.style.left=s+l.caretX+"px",n.style.left=s+l.caretX+"px",a.style.top=o+l.caretY-a.offsetHeight-10+"px"}createUserRelatedData(){dlmReportsInstance.userRelatedData=[],Object.values(dlmReportsInstance.userDownloads).forEach((t,e)=>{var a;"0"!==t.user_id&&(a=[t.user_id,t.download_id,t.download_date,t.download_status],t="user_"+t.user_id,void 0!==dlmReportsInstance.userRelatedData[t]?dlmReportsInstance.userRelatedData[t].push(a):dlmReportsInstance.userRelatedData[t]=[a])})}logsDataByDate(t,e){var{startDate:t,endDate:e}={...dlmReportsInstance.getSetDates(t,e)};dlmReportsInstance.userDownloads=JSON.parse(JSON.stringify(dlmReportsInstance.dlmUsersStats.logs));let a=new Date(t),n=(a.setDate(a.getDate()-1),a=a.getTime(),new Date(e));n.setDate(n.getDate()+1),n=n.getTime(),dlmReportsInstance.userDownloads=dlmReportsInstance.userDownloads.filter((t,e)=>{t=dlmReportsInstance.createDateElement(new Date(t.download_date));return(t=new Date(t).getTime())>a&&t<n}),dlmReportsInstance.createUserRelatedData(),dlmReportsInstance.setMostActiveUser(),dlmReportsInstance.setLoggedOutDownloads(),dlmReportsInstance.setLoggedInDownloads(),jQuery(document).trigger("dlm_set_logs_data_by_date",[dlmReportsInstance])}setMostActiveUser(){var t=dlmReportsInstance.getUserByID(dlmReportsInstance.getMostActiveID()[0]);jQuery(".dlm-reports-block-summary li#most_active_user span").html(dlmReportsInstance.userToolTipMarkup(t))}getMostActiveID(){return Object.values(dlmReportsInstance.userRelatedData).length?Object.values(dlmReportsInstance.userRelatedData).reduce((t,e,a)=>parseInt(t.length)>parseInt(e.length)&&0<t.length&&null!==dlmReportsInstance.getUserByID(t[0][0])?t:null!==dlmReportsInstance.getUserByID(e[0][0])?e:[],[]):0}getUserByID(e){if(!e||"0"===e)return null;var t=Object.values(dlmReportsInstance.dlmUsersStats.users).filter(t=>parseInt(e)===parseInt(t.ID));return 0<t.length?t[0]:null}getLoggedInDownloads(){return Object.values(dlmReportsInstance.userRelatedData).length?1<Object.values(dlmReportsInstance.userRelatedData).length?Object.values(dlmReportsInstance.userRelatedData).reduce((t,e)=>parseInt(t)+parseInt(e.length),0):Object.values(dlmReportsInstance.userRelatedData)[0].length:0}setLoggedInDownloads(){const t=dlmReportsInstance.getLoggedInDownloads();jQuery(".dlm-reports-block-summary li#logged_in span,#total_downloads_summary_wrapper .dlm-reports-logged-in").html(t.toLocaleString())}getLoggedOutDownloads(){return dlmReportsInstance.userDownloads.length-dlmReportsInstance.getLoggedInDownloads()}setLoggedOutDownloads(){const t=dlmReportsInstance.getLoggedOutDownloads();jQuery(".dlm-reports-block-summary li#logged_out span,#total_downloads_summary_wrapper .dlm-reports-logged-out").html(t.toLocaleString())}userToolTipMarkup(t){let e='<div class="dlm-user-reports">';return e=(e=e+'<div class="wpchill-tooltip"><i>[?]</i>'+'<div class="wpchill-tooltip-content">')+("<span>User ID: "+(null!==t?t.id:"--")+"</span>"),"object"!=typeof t&&t.url.length&&(e+="<span>User URL: "+(null!==t?t.url:"--")+"</span>"),e+="<span>User registration date: "+(null!==t?t.registered:"--")+"</span>",null!==t&&void 0!==t.role&&t.role.length&&(e+="<span>User role: "+t.role+"</span>"),e=(e+="</div></div>")+(null!==t?t.display_name:"--")+"</div>"}setUserDownloads(t=0,e=!1){const a=jQuery("#users_download_log"),n=jQuery("#users_download_log .user-logs__list");if(n.empty(),!0!==e){let e=[];e=(null!==dlmReportsInstance.tempDownloads?JSON.parse(JSON.stringify(dlmReportsInstance.tempDownloads)):JSON.parse(JSON.stringify(dlmReportsInstance.userDownloads))).slice(10*parseInt(t),10*parseInt(t+1));for(let t=0;t<e.length;t++){var s=dlmReportsInstance.getUserByID(e[t].user_id.toString()),o=dlmReportsInstance.getDownloadCPT(e[t].download_id.toString()),r={key:t,user:"0"!==e[t].user_id&&null!=s?s.user_nicename:"--",ip:e[t].user_ip,role:null!==s&&null!==s.role?s.role:"--",download:void 0!==o?o.title:"--",valid_user:"0"!==e[t].user_id,edit_link:"user-edit.php?user_id="+e[t].user_id,edit_download_link:void 0!==o?dlmAdminUrl+"post.php?post="+o.id+"&action=edit":"#",status:e[t].download_status,download_date:e[t].download_date};jQuery(document).trigger("dlm_reports_user_logs_item_before_render",[r,dlmReportsInstance,e[t],s,o]),new dlmBackBone.modelUserLogs(r)}dlmReportsInstance.stopSpinner(jQuery("#users_download_log")),10!==e.length?a.find('.user-downloads-block-navigation button[data-action="load-more"]').attr("disabled","disabled"):a.find('.user-downloads-block-navigation button[data-action="load-more"]').removeAttr("disabled"),10<dlmReportsInstance.userDownloads.length?a.find(".user-downloads-block-navigation button").removeClass("hidden"):a.find(".user-downloads-block-navigation button").addClass("hidden")}}handleUserDownloads(){jQuery(".user-downloads-block-navigation").on("click","button",function(t){t.stopPropagation();let e=jQuery(this).parents("#users_downloads_table_wrapper"),a=e.find("#users_download_log"),n=a.attr("data-page"),s=jQuery(this),o=parseInt(n)+1,r=0!==n?parseInt(n)-1:0,d=e.find(".downloads-block-navigation button").first(),l=e.find(".downloads-block-navigation button").last();s.attr("disabled","disabled");t={data:dlmReportsInstance.tempDownloads,main_parent:e,offsetHolder:a,offset:n,link:s,nextPage:o,prevPage:r,prevButton:d,nextButton:l,doAction:dlmReportsInstance.setUserDownloads};dlmReportsInstance.handleSliderNavigation(t)})}togglePageSettings(){jQuery("#dlm-toggle-settings").on("click",function(t){t.stopPropagation(),jQuery(this).find(".dlm-toggle-settings__settings").toggleClass("display")}),jQuery(".dlm-toggle-settings__settings").on("click",function(t){t.stopPropagation()}),jQuery("html,body").on("click",function(){jQuery(this).find(".dlm-toggle-settings__settings").removeClass("display")}),jQuery(document).on("change",".wpchill-toggle__input",function(t){const e=jQuery(this),a=e.attr("name"),n={action:"dlm_update_report_setting",name:a,checked:e.is(":checked"),_ajax_nonce:dlmReportsNonce};jQuery.post(ajaxurl,n,function(t){a,jQuery(document).trigger("dlm_settings_ajax_response",[dlmReportsInstance,e,t])})})}getMaxDownload(){let e=0;return dlmReportsInstance.dataSets.forEach(t=>{t=Object.values(t.data).reduce((t,e)=>e<t?t:e,0);e<t&&(e=t)}),parseInt(e)}setChartTooltipDate(t,e,a){let n="";var s,o,r;return n="undefined"!==e.chartType&&"months"===e.chartType?(moment(t).year(),s=moment(t).month(),a=Object.keys(a)[Object.keys(a).length-1],o=moment(a).month(moment(a).month()-1).format("YYYY-MM"),r=moment(t).format("YYYY-MM"),s<11?r===o?moment(r).format("MMMM, YYYY"):moment(t).format("MMM")+" - "+moment(t).month(s+1).format("MMM")+moment(t).format(", YYYY"):r===o||r===a?moment(r).format("MMMM, YYYY"):moment(t).format("MMM")+moment(t).format(" YYYY")+" - "+moment(t).month(s+1).format("MMM")+moment(t).month(s+1).format(", YYYY")):"undefined"!==e.chartType&&"months"===e.chartType?moment(t).format("MMMM, YYYY"):moment(t).format("MMMM Do, YY")}closeDatePickers(t){jQuery(".dlm-reports-header-date-selector").not(t).each(function(){var t={target:jQuery(this).attr("id")};dlmReportsInstance.hideDatepicker(jQuery(this),t)})}shortNumber(t){return t=4<=(t="string"==typeof t?t.replace(/,/gi,""):parseInt(t).toString()).length?parseInt(t.substring(0,t.length-3)).toLocaleString()+"k":t}getDownloadByID(e){let a={total:0},n;return dlmReportsInstance.tempDownloads.forEach(function(t){e===t.download_id&&(n=t,a.total=a.total+1,jQuery(document).trigger("dlm_download_by_id",[dlmReportsInstance,a,n]))}),a}getDownloadCPT(e){var t=dlmReportsInstance.mostDownloaded.filter(t=>t.id===e,0)[0];return jQuery(document).trigger("dlm_download_cpt",[dlmReportsInstance,t]),t}setSpinner(t){t.append('<div class="dlm-reports-spinner"><span></span></div>')}stopSpinner(t){t.find(".dlm-reports-spinner").remove()}}