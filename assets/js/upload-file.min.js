jQuery(function(o){let i=[],a={};var e=Backbone.Model.extend({dlmUploaderInstance:null,initialize:function(e){var n;this.uploaderOptions=e,dlmUploaderInstance=this,(n=(e=new wp.Uploader(dlmUploaderInstance.uploaderOptions)).dropzone).on("dropzone:enter",dlmUploaderInstance.show),n.on("dropzone:leave",dlmUploaderInstance.hide),e.uploader.bind("FilesAdded",dlmUploaderInstance.dlmFileAdded),e.uploader.bind("FileUploaded",dlmUploaderInstance.dlmAddFileToPath),e.uploader.bind("Error",dlmUploaderInstance.dlmUploadError)},dlmAddFileToPath:function(o,i){const a=i.attachment.attributes.url;if("plupload-browse-button"!==jQuery(o.settings.browse_button).attr("id")){const n=jQuery(o.settings.browse_button).parents("td").find("textarea");n.parent().removeClass("dlm-blury");let e=n.val();e=e?e+"\n"+a:a,n.val(e)}else jQuery(".download_monitor_files a.add_file").trigger("click"),jQuery(document).on("dlm_new_file_added",function(){const e=jQuery(".dlm-metaboxes.downloadable_files").find(".downloadable_file").first(),n=e.find("textarea"),t=dlmUploaderInstance.retrieveVersion(i),r=e.find('input[name*="downloadable_file_version"]');jQuery(o.settings.container).removeClass("dlm-blury"),n.val(a),null!==t&&r.val(t)})},dlmFileAdded:function(e,n){if("plupload-browse-button"!==jQuery(e.settings.browse_button).attr("id")){const t=jQuery(e.settings.browse_button).parents("td").find("textarea");t.parent().addClass("dlm-blury")}else jQuery(e.settings.container).addClass("dlm-blury")},dlmUploadError:function(e,n){jQuery(e.settings.browse_button).parent().append('<p class="error description" style="color:red;">'+n.message+"</p>"),setTimeout(function(){jQuery(e.settings.browse_button).parent().find(".error.description").remove()},3500)},retrieveVersion:function(e){const n=e.name;let t=n.split("-")[1],r=t.split(".");return r=r.pop(),(t=t.slice(0,-(r.length+1))).length?t:null}}),n=Backbone.View.extend({tagName:"div",className:"dlm-uploader-editor",template:wp.template("uploader-editor"),localDrag:!1,overContainer:!1,overDropzone:!1,draggingFile:null,args:{},elementContainer:null,initialize:function(e){return this.initialized=!1,this.args=e,this.elementContainer=jQuery(this.args.container[0]).attr("id"),window.tinyMCEPreInit&&window.tinyMCEPreInit.dragDropUpload&&this.browserSupport()&&(this.$document=o(document),this.dropzone=null,this.files=[],this.$document.on("drop","#"+this.elementContainer+" .dlm-uploader-editor",_.bind(this.drop,this)),this.$document.on("click","#"+this.elementContainer+" .dlm-uploader-editor",_.bind(this.click,this)),this.$document.on("dragover","#"+this.elementContainer+" .dlm-uploader-editor",_.bind(this.dropzoneDragover,this)),this.$document.on("dragleave","#"+this.elementContainer+" .dlm-uploader-editor",_.bind(this.dropzoneDragleave,this)),this.$document.on("dragover",_.bind(this.containerDragover,this)),this.$document.on("dragleave",_.bind(this.containerDragleave,this)),this.$document.on("dragstart dragend drop",_.bind(function(e){this.localDrag="dragstart"===e.type,"drop"===e.type&&this.containerDragleave()},this)),this.initialized=!0),this},browserSupport:function(){var e=document.createElement("div");return("draggable"in e||"ondragstart"in e&&"ondrop"in e)&&!!(window.File&&window.FileList&&window.FileReader)},isDraggingFile:function(e){return null!==this.draggingFile?this.draggingFile:!_.isUndefined(e.originalEvent)&&!_.isUndefined(e.originalEvent.dataTransfer)&&(this.draggingFile=-1<_.indexOf(e.originalEvent.dataTransfer.types,"Files")&&-1===_.indexOf(e.originalEvent.dataTransfer.types,"text/plain"),this.draggingFile)},refresh:function(e){return this.dropzone.toggle(this.overContainer||this.overDropzone),_.isUndefined(e)||o(e.target).closest(".dlm-uploader-editor").toggleClass("droppable",this.overDropzone),this.overContainer||this.overDropzone||(this.draggingFile=null),this},render:function(){return this.initialized&&(this.$el.html(this.template()),jQuery("#"+this.elementContainer).append(this.$el),this.dropzone=this.$el),this},containerDragover:function(e){!this.localDrag&&this.isDraggingFile(e)&&(this.overContainer=!0,this.refresh())},containerDragleave:function(){this.overContainer=!1,_.delay(_.bind(this.refresh,this),50)},dropzoneDragover:function(e){if(!this.localDrag&&this.isDraggingFile(e))return this.overDropzone=!0,this.refresh(e),!1},dropzoneDragleave:function(e){this.overDropzone=!1,_.delay(_.bind(this.refresh,this,e),50)},drop:function(e){return this.containerDragleave(e),this.dropzoneDragleave(e),!1},click:function(e){this.containerDragleave(e),this.dropzoneDragleave(e),this.localDrag=!1}});a.uploadHandlerModel=e,a.uploadHandlerView=n,jQuery(document).ready(function(){var e={browser:o("#plupload-browse-button"),plupload:{multi_selection:!1},params:{type:"dlm_download"},container:o("#drag-drop-area"),dropzone:o("#drag-drop-area")};new a.uploadHandlerModel(e);const n=new a.uploadHandlerView(e);n.render()}),o(".dlm_upload_file").each((e,n)=>{i.push(o(n));const t={browser:o(n),plupload:{multi_selection:!1},params:{type:"dlm_download"},container:o(n).parents("table.dlm-metabox-content"),dropzone:o(n).parents("table.dlm-metabox-content")},r=(new a.uploadHandlerModel(t),new a.uploadHandlerView(t));r.render()}),o(document).on("dlm_new_file_added",()=>{o(".dlm_upload_file").each((e,n)=>{if(i.includes(o(n)))return!0;i.push(o(n));const t={browser:o(n),plupload:{multi_selection:!1},params:{type:"dlm_download"},container:o(n).parents("table.dlm-metabox-content"),dropzone:o(n).parents("table.dlm-metabox-content")},r=(new a.uploadHandlerModel(t),new a.uploadHandlerView(t));r.render()})})});