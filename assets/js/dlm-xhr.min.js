jQuery(function(e){new DLM_XHR_Download});class DLM_XHR_Download{constructor(){(dlmXHRinstance=this).init()}init(){dlmXHRinstance.attachButtonEvent()}attachButtonEvent(){let t="",o="";jQuery.each(dlmXHR.xhr_links.class,function(e,d){-1<d.indexOf("[class")||-1<d.indexOf("[id")?t+=o+" "+d:t+=o+" ."+d,o=","}),jQuery("html, body").on("click",".dlm-no-access-modal-overlay, .dlm-no-access-modal-close",function(e){jQuery("#dlm-no-access-modal").remove()}),jQuery("html, body").on("click",t,function(e){return!!jQuery(this).hasClass("dlm-no-xhr-download")||(0<=jQuery(this).attr("href").indexOf("?add-to-cart")||void dlmXHRinstance.handleDownloadClick(this,e))})}handleDownloadClick(e,d){d.stopPropagation();var t=e.getAttribute("href");let o={button:e,href:t,buttonObj:jQuery(e)};-1===o.href.indexOf("blob:http")&&"#"!==o.href&&(d.preventDefault(),dlmXHRinstance.retrieveBlob(o))}retrieveBlob(e){let{button:r,href:n,buttonObj:l}=e,a;const s=new XMLHttpRequest,i=dlmXHR.prevent_duplicates,c=l.attr("target");let m=l.attr("class");m=void 0!==m&&""!==m?m.replace("dlm-download-started","").replace("dlm-download-completed",""):"",l.addClass("dlm-download-started"),r.setAttribute("href","#"),r.removeAttribute("download"),r.setAttribute("disabled","disabled");e=0<n.indexOf("?")?n+"&nonce="+dlmXHR.nonce:n+"?nonce="+dlmXHR.nonce;jQuery(document).trigger("dlm_download_triggered",[this,r,l,a]),s.responseType="blob",s.onreadystatechange=function(){var{status:e,readyState:d,statusText:t}=s;let o=s.getAllResponseHeaders().split("\r\n").reduce((e,d)=>{var[d,t]=d.split(": ");return e[d]=t,e},{});if(2===s.readyState){if(void 0!==o["dlm-no-waypoints"]&&(s.abort(),window.location.href=n),void 0!==o["dlm-external-download"]){s.abort();let e="";return void 0!==o["dlm-file-name"]?(e=o["dlm-file-name"].replace(/\"/g,"").replace(";",""),e=decodeURI(e)):void 0!==o["content-disposition"]&&(e=(e=o["content-disposition"].split("filename=")[1]).replace(/\"/g,"").replace(";",""),e=decodeURI(e)),void dlmXHRinstance.dlmExternalDownload(o,r,l,e,n)}if(0===Object.keys(o).filter(e=>-1!==e.indexOf("dlm-")).length&&(s.abort(),window.location.href=n),void 0!==o["dlm-error"]&&""!==o["dlm-error"]&&null!==o["dlm-error"])return dlmXHRinstance.dlmLogDownload(o,"failed",!1),r.removeAttribute("download"),r.setAttribute("href",n),l.removeClass().addClass(m).find("span.dlm-xhr-progress").remove(),s.abort(),void(void 0!==o["dlm-no-access-modal"]&&0!=o["dlm-no-access-modal"]?dlmXHRinstance.dlmNoAccessModal(o["dlm-download-id"],o["dlm-version-id"],o["dlm-no-access-modal-text"]):l.append('<span class="dlm-xhr-error">'+o["dlm-error"]+"</span>"));if(void 0!==o["dlm-redirect"]&&""!==o["dlm-redirect"]&&null!==o["dlm-redirect"])return dlmXHRinstance.dlmLogDownload(o,"redirected",!1,o["dlm-redirect"],o["dlm-no-access"],c),r.removeAttribute("download"),r.setAttribute("href",n),l.removeClass().addClass(m).find("span.dlm-xhr-progress").remove(),void s.abort()}if(404==e&&2==d){let e=document.createElement("p");e.innerHTML=t,r.parentNode.appendChild(e)}if(401==e&&2==d&&(window.location.href=t),403==e&&2==d){let e=document.createElement("p");e.innerHTML=t,r.parentNode.appendChild(e)}if(200==e&&4==d){t=s.response;let e=o["content-disposition"].split("filename=")[1];e=e.replace(/\"/g,"").replace(";",""),e=decodeURI(e),a=URL.createObjectURL(t),r.removeEventListener("click",dlmXHRinstance.handleDownloadClick),r.setAttribute("download",""+e),r.setAttribute("href",a),r.click(),l.removeClass().addClass(m+" dlm-download-complete"),dlmXHRinstance.attachButtonEvent(),jQuery(document).trigger("dlm_download_complete",[this,r,l,a]),dlmXHRinstance.dlmLogDownload(o,"completed",i),window.URL.revokeObjectURL(a),r.removeAttribute("download"),r.setAttribute("href",n),setTimeout(function(){l.removeClass().addClass(m).find("span.dlm-xhr-progress").remove()},4e3)}},s.addEventListener("progress",function(e){let d=e.loaded/e.total*100;d=d.toFixed(2);var t;l.find("span.dlm-xhr-progress").remove(),t="dlm-download-started download-"+10*Math.ceil(d/10),1/0!=d&&l.append('<span class="dlm-xhr-progress">&nbsp;'+d+"%</span>"),l.removeClass().addClass(m+" "+t),jQuery(document).trigger("dlm_download_progress",[this,r,l,a,e,d])}),s.onerror=function(){r.removeAttribute("download"),r.setAttribute("href",n),l.removeClass().addClass(m+" dlm-no-xhr-download").find("span.dlm-xhr-progress").remove(),l.append('<span class="dlm-xhr-error">'+dlmXHRtranslations.error+"</span>"),console.log("** An error occurred during the transaction")},s.open("GET",e,!0),s.setRequestHeader("dlm-xhr-request","dlm_XMLHttpRequest"),s.send()}dlmLogDownload(e,d,t,o=null,r=null,n="_self"){null!==r&&(window.location.href=o);r=window.location.href,d={download_id:e["dlm-download-id"],version_id:e["dlm-version-id"],status:d,cookie:t,currentURL:r,action:"log_dlm_xhr_download",responseHeaders:e,nonce:dlmXHR.nonce};jQuery.post(dlmXHR.ajaxUrl,d,function(e){null!==o&&(null==n&&(n="_self"),window.open(o,n))})}dlmNoAccessModal(e,d,t){let o="empty-download",r="empty-version",n="";void 0!==e&&(o=e),void 0!==d&&(r=d),void 0!==t&&(n=t);e={download_id:o,version_id:r,modal_text:n,action:"no_access_dlm_xhr_download",nonce:dlmXHR.nonce};jQuery.post(dlmXHR.ajaxUrl,e,function(e){jQuery("#dlm-no-access-modal").remove(),jQuery("body").append(e)})}dlmExternalDownload(e,o,r,n,l){const a=new XMLHttpRequest,d=e["dlm-external-download"];r.attr("target");let s=r.attr("class"),i;s=void 0!==s&&""!==s?s.replace("dlm-download-started","").replace("dlm-download-completed",""):"",r.addClass("dlm-download-started"),o.setAttribute("href","#"),o.removeAttribute("download"),o.setAttribute("disabled","disabled"),jQuery(document).trigger("dlm_download_triggered",[this,o,r,i]),a.responseType="blob",a.onreadystatechange=function(){var{status:e,readyState:d}=a,t=a.getAllResponseHeaders().split("\r\n").reduce((e,d)=>{var[d,t]=d.split(": ");return e[d]=t,e},{});if(403===e)return dlmXHRinstance.dlmLogDownload(t,"failed",!1),a.abort(),void r.append('<span class="dlm-xhr-error">Acces Denied to file.</span>');200==e&&4==d&&(e=a.response,i=URL.createObjectURL(e),o.removeEventListener("click",dlmXHRinstance.handleDownloadClick),o.setAttribute("download",""+n),o.setAttribute("href",i),o.click(),r.removeClass().addClass(s+" dlm-download-complete"),dlmXHRinstance.attachButtonEvent(),jQuery(document).trigger("dlm_download_complete",[this,o,r,i]),dlmXHRinstance.dlmLogDownload(t,"completed",!1),window.URL.revokeObjectURL(i),o.removeAttribute("download"),o.setAttribute("href",l),setTimeout(function(){r.removeClass().addClass(s).find("span.dlm-xhr-progress").remove()},1e3))},a.addEventListener("progress",function(e){let d=e.loaded/e.total*100;d=d.toFixed(2);var t;r.find("span.dlm-xhr-progress").remove(),t="dlm-download-started download-"+10*Math.ceil(d/10),1/0!=d&&r.append('<span class="dlm-xhr-progress">&nbsp;'+d+"%</span>"),r.removeClass().addClass(s+" "+t),jQuery(document).trigger("dlm_download_progress",[this,o,r,i,e,d])}),a.onerror=function(){o.removeAttribute("download"),o.setAttribute("href",l),r.removeClass().addClass(s+" .dlm-no-xhr-download").find("span.dlm-xhr-progress").remove(),r.append('<span class="dlm-xhr-error">'+dlmXHRtranslations.error+"</span>"),console.log("** An error occurred during the transaction")},a.open("GET",d,!0),a.setRequestHeader("dlm-xhr-request","dlm_XMLHttpRequest"),a.send()}}