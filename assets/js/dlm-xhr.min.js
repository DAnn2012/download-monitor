function attachButtonEvent(){let o="",d="";jQuery.each(dlmXHR.xhr_links.class,function(e,t){-1<t.indexOf("[class")||-1<t.indexOf("[id")?o+=d+" "+t:o+=d+" ."+t,d=","}),jQuery("html, body").on("click",o,function(e){handleDownloadClick(this,e)})}function handleDownloadClick(e,t){t.stopPropagation();var o=e.getAttribute("href");let d={button:e,href:o,buttonObj:jQuery(e)};if(-1!==d.href.indexOf("blob:http"))return d.buttonObj.addClass("download-100"),void setTimeout(function(){d.buttonObj.removeClass("download-100")},1500);"#"===d.href?console.log("No file path found"):(t.preventDefault(),retrieveBlob(d))}function retrieveBlob(e){let{button:r,href:l,buttonObj:a}=e,i;const s=new XMLHttpRequest,c=a.attr("class"),u=dlmXHR.prevent_duplicates;a.addClass("dlm-download-started"),r.setAttribute("href","#"),r.removeAttribute("download"),r.setAttribute("disabled","disabled");e=0<l.indexOf("/?")?l+"&nonce="+dlmXHR.nonce:l+"?nonce="+dlmXHR.nonce;jQuery(document).trigger("dlm_download_triggered",[this,r,a,i]),s.responseType="blob",s.onreadystatechange=function(){var{status:e,readyState:t,statusText:o}=s;let d=s.getAllResponseHeaders().split("\r\n").reduce((e,t)=>{var[t,o]=t.split(": ");return e[t]=o,e},{});if(void 0!==d["dlm-external-download"])return s.abort(),n=d["dlm-file-name"].replace(/\"/g,"").replace(";",""),void dlmExternalDownload(d,r,a,n,l);if(2==s.readyState&&void 0!==d["dlm-error"]&&""!==d["dlm-error"]&&null!==d["dlm-error"])return dlmLogDonwload(d["dlm-download-id"],d["dlm-version-id"],"failed",!1),s.abort(),void a.append('<span class="dlm-xhr-error">'+d["dlm-error"]+"</span>");if(2==s.readyState&&void 0!==d["dlm-redirect"]&&""!==d["dlm-redirect"]&&null!==d["dlm-redirect"])return dlmLogDonwload(d["dlm-download-id"],d["dlm-version-id"],"redirected",!1,d["dlm-redirect"],d["dlm-no-access"]),void s.abort();if(2==s.readyState&&s.status,404==e&&2==t){let e=document.createElement("p");e.innerHTML=o,r.parentNode.appendChild(e)}if(401==e&&2==t&&(window.location.href=o),403==e&&2==t){let e=document.createElement("p");e.innerHTML=o,r.parentNode.appendChild(e)}if(200==e&&4==t){var n=s.response;let e=d["content-disposition"].split("filename=")[1];e.replace(/\"/g,"").replace(";",""),i=URL.createObjectURL(n),r.removeEventListener("click",handleDownloadClick),r.setAttribute("download",""+e),r.setAttribute("href",i),r.click(),a.removeClass().addClass(c+" dlm-download-complete"),attachButtonEvent(),jQuery(document).trigger("dlm_download_complete",[this,r,a,i]),dlmLogDonwload(d["dlm-download-id"],d["dlm-version-id"],"completed",u),setTimeout(function(){window.URL.revokeObjectURL(i),r.removeAttribute("download"),r.setAttribute("href",l)},6e4)}},s.addEventListener("progress",function(e){var t=e.loaded/e.total*100,t=Math.round(t);let o="download-"+10*Math.ceil(t/10);"100"!==t&&(o+=" dlm-download-started"),a.removeClass().addClass(c+" "+o),jQuery(document).trigger("dlm_download_progress",[this,r,a,i,e,t])}),s.onerror=function(){console.log("** An error occurred during the transaction")},s.open("GET",e,!0),s.setRequestHeader("dlm-xhr-request","dlm_XMLHttpRequest"),s.send()}function dlmLogDonwload(e,t,o,d,n=null,r=null){null!==r?window.location.href=n:(r={download_id:e,version_id:t,status:o,cookie:d,action:"log_dlm_xhr_download",nonce:dlmXHR.nonce},jQuery.post(dlmXHR.ajaxUrl,r,function(e){null!==n&&(window.location.href=n)}))}function dlmExternalDownload(o,d,n,r,l){const a=new XMLHttpRequest,e=o["dlm-external-download"],i=n.attr("class");let s;n.addClass("dlm-download-started"),d.setAttribute("href","#"),d.removeAttribute("download"),d.setAttribute("disabled","disabled"),jQuery(document).trigger("dlm_download_triggered",[this,d,n,void 0]),a.responseType="blob",a.onreadystatechange=function(){var{status:e,readyState:t}=a;a.getAllResponseHeaders().split("\r\n").reduce((e,t)=>{var[t,o]=t.split(": ");return e[t]=o,e},{});if(403===e)return dlmLogDonwload(o["dlm-download-id"],o["dlm-version-id"],"failed",!1),a.abort(),void n.append('<span class="dlm-xhr-error">Acces Denied to file.</span>');200==e&&4==t&&(e=a.response,s=URL.createObjectURL(e),d.removeEventListener("click",handleDownloadClick),d.setAttribute("download",""+r),d.setAttribute("href",s),d.click(),n.removeClass().addClass(i+" dlm-download-complete"),attachButtonEvent(),jQuery(document).trigger("dlm_download_complete",[this,d,n,s]),dlmLogDonwload(o["dlm-download-id"],o["dlm-version-id"],"completed",!1),setTimeout(function(){window.URL.revokeObjectURL(s),d.removeAttribute("download"),d.setAttribute("href",l)},6e4))},a.onerror=function(){console.log("** An error occurred during the transaction")},a.open("GET",e,!0),a.setRequestHeader("dlm-xhr-request","dlm_XMLHttpRequest"),a.send()}attachButtonEvent();